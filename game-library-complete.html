<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Library - Track Your Gaming Journey (v5.3 - Firebase Load Fixed)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --surface: #ffffff;
            --background: #f3f4f6;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Grid */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 1rem;
            padding: 3rem;
            margin-bottom: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            align-items: center;
            background-size: cover;
            background-position: center;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30,41,59,0.9) 0%, rgba(51,65,85,0.85) 50%, rgba(102,126,234,0.1) 100%);
            z-index: 1;
        }
        
        /* No overlay when image is present */
        .hero.has-image::before {
            background: linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%);
        }

        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 700px;
        }

        .hero-badge {
            display: inline-block;
            background: rgba(102,126,234,0.2);
            color: #a5b4fc;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.75rem;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
        }

        .hero-meta {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .hero-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .hero-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .hero-empty {
            text-align: center;
            padding: 2rem;
        }

        .hero-empty-icon {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        /* Toolbar */
        .toolbar {
            background: var(--surface);
            padding: 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: var(--shadow);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.625rem 1rem;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Sort Dropdown */
        .sort-dropdown {
            position: relative;
            min-width: 160px;
        }

        .sort-dropdown select {
            width: 100%;
            padding: 0.625rem 2.5rem 0.625rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            font-family: inherit;
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .sort-dropdown select:hover {
            border-color: var(--primary);
        }

        .sort-dropdown select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .sort-dropdown::after {
            content: '‚ñº';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.625rem;
            color: var(--text-light);
            pointer-events: none;
        }

        /* Games Grid */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .game-card {
            background: var(--surface);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            cursor: pointer;
        }

        .game-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .game-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 2rem;
            text-align: center;
            color: white;
            position: relative;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
        }

        .game-header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(102,126,234,0.85), rgba(118,75,162,0.85));
            z-index: 1;
        }
        
        /* No overlay when image is present */
        .game-header.has-image::before {
            display: none;
        }

        .game-header > * {
            position: relative;
            z-index: 2;
        }

        .game-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .game-status-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .game-body {
            padding: 1.5rem;
        }

        .game-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .game-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .game-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-section {
            margin-bottom: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #34d399);
            border-radius: 1rem;
            transition: width 0.3s;
        }

        .game-actions {
            display: flex;
            gap: 0.75rem;
        }

        .game-btn {
            flex: 1;
            padding: 0.625rem;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .game-btn:hover {
            background: var(--background);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 1rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--background);
            color: var(--text);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-icon {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .empty-text {
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .hero {
                padding: 2rem;
            }

            .hero-title {
                font-size: 2rem;
            }

            .games-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .sort-dropdown {
                width: 100%;
            }

            .filter-group {
                width: 100%;
                justify-content: stretch;
            }

            .filter-btn {
                flex: 1;
            }

            .tracker-modal-content {
                width: 95%;
                height: 95%;
            }
        }

        /* Tracker Preview Modal */
        .tracker-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            padding: 2rem;
        }

        .tracker-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tracker-modal-content {
            background: var(--surface);
            border-radius: 1rem;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        .tracker-modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 1rem 1rem 0 0;
        }

        .tracker-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .tracker-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .tracker-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .tracker-modal-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
            position: relative;
        }

        .tracker-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .tracker-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--success);
        }

        .game-actions-extended {
            display: flex;
            gap: 0.5rem;
        }

        .game-actions-extended .game-btn {
            flex: 1;
            min-width: 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üéÆ</span>
                <span>Game Library</span>
            </div>
            <div class="header-actions">
                <span id="authStatus" style="font-size: 0.875rem; font-weight: 600; margin-right: 1rem; color: #f59e0b;" title="Storage mode">üíæ Local</span>
                <button class="btn btn-secondary" onclick="handleCloudSyncClick()" title="Force sync from Firebase" id="cloudSyncBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold;">
                    üîÑ Sync Now
                </button>
                <button class="btn btn-primary" onclick="openAddModal()">
                    ‚ûï Add Game
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    üíæ Export Data
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Statistics -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalGames">0</div>
                <div class="stat-label">Total Games</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedGames">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="inProgressGames">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalHours">0</div>
                <div class="stat-label">Total Hours</div>
            </div>
        </div>

        <!-- Currently Playing Hero -->
        <div class="hero" id="heroSection">
            <!-- Dynamic content -->
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" placeholder="Search games..." id="searchInput" oninput="filterGames()">
            </div>
            <div class="sort-dropdown">
                <select id="sortSelect" onchange="sortGames()">
                    <option value="title">Sort by: Title</option>
                    <option value="date">Sort by: Date Added</option>
                    <option value="progress">Sort by: Progress</option>
                    <option value="platform">Sort by: Platform</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
                <button class="filter-btn" data-filter="playing" onclick="setFilter('playing')">Playing</button>
                <button class="filter-btn" data-filter="completed" onclick="setFilter('completed')">Completed</button>
                <button class="filter-btn" data-filter="backlog" onclick="setFilter('backlog')">Backlog</button>
            </div>
        </div>

        <!-- Games Grid -->
        <div class="games-grid" id="gamesGrid">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- Add/Edit Game Modal -->
    <div class="modal" id="gameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New Game</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="gameForm" onsubmit="saveGame(event)">
                    <div class="form-group">
                        <label class="form-label">Game Title *</label>
                        <input type="text" class="form-input" id="gameTitle" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Icon (Emoji)</label>
                            <input type="text" class="form-input" id="gameIcon" placeholder="üéÆ" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cover Image URL (optional)</label>
                            <input type="url" class="form-input" id="gameImageUrl" placeholder="https://joeg592.github.io/game-library/images/ff16-cover.jpg">
                            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                <strong>üí° Tip:</strong> Upload your cover images to GitHub /images/ folder and paste the URL here.
                            </small>
                        </div>
                    </div>
                    
                    <div id="imagePreview" style="display: none; margin-bottom: 1.5rem;">
                        <img id="previewImg" style="max-width: 100%; height: 200px; object-fit: cover; border-radius: 0.5rem;">
                        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-danger" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;" onclick="removeImage()">Remove Image</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Platform</label>
                            <select class="form-select" id="gamePlatform">
                                <option value="PC">PC</option>
                                <option value="PlayStation">PlayStation</option>
                                <option value="Xbox">Xbox</option>
                                <option value="Nintendo Switch">Nintendo Switch</option>
                                <option value="Mobile">Mobile</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-select" id="gameStatus" required>
                                <option value="backlog">Backlog</option>
                                <option value="playing">Playing</option>
                                <option value="completed">Completed</option>
                                <option value="on-hold">On Hold</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="gameStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="gameCurrentlyPlaying" style="margin-right: 0.5rem;">
                                Set as Currently Playing
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Hours Played</label>
                            <input type="number" class="form-input" id="gameHours" min="0" value="0">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Will auto-update from tracker if available</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Progress %</label>
                            <input type="number" class="form-input" id="gameProgress" min="0" max="100" value="0">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Will auto-update from tracker if available</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Favorite Quote</label>
                        <textarea class="form-textarea" id="gameQuote" placeholder="A memorable quote from the game..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="gameNotes" placeholder="Your thoughts, tips, or reminders..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Game Tracker URL (optional)</label>
                        <input type="url" class="form-input" id="gameTrackerUrl" placeholder="https://joeg592.github.io/game-library/trackers/ff16-tracker.html">
                        <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                            <strong>üí° Tip:</strong> Host your tracker HTML on GitHub /trackers/ folder. Progress will sync across all devices automatically!
                        </small>
                    </div>

                    <input type="hidden" id="gameId">
                    <input type="hidden" id="gameTrackerUrlData">
                    <input type="hidden" id="gameImageUrlData">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" form="gameForm" class="btn btn-success">Save Game</button>
            </div>
        </div>
    </div>

    <!-- Cloud Settings Modal -->
    <div class="modal" id="cloudModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">‚òÅÔ∏è Cloud Sync Settings</h2>
                <button class="modal-close" onclick="closeCloudModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Google Sheets URL</label>
                    <input type="text" class="form-input" id="cloudApiUrl" placeholder="Paste CSV URL or Apps Script URL">
                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                        <strong>Option 1 (CSV - Read Only):</strong> File ‚Üí Publish to web ‚Üí CSV<br>
                        <strong>Option 2 (Apps Script - Full Sync):</strong> Use deployed Apps Script URL
                    </small>
                </div>
                
                <div id="cloudStatus" style="margin-top: 1rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--background); border-radius: 0.5rem; font-size: 0.875rem;">
                    <strong>Two Methods Available:</strong>
                    <div style="margin-top: 0.75rem;">
                        <strong style="color: var(--primary);">üìÑ CSV Method (Simple):</strong>
                        <ul style="margin: 0.25rem 0 0 1.25rem; line-height: 1.6; font-size: 0.8125rem;">
                            <li>Read-only (edit sheet to update)</li>
                            <li>No CORS issues</li>
                            <li>Works instantly</li>
                        </ul>
                    </div>
                    <div style="margin-top: 0.75rem;">
                        <strong style="color: var(--success);">üîÑ Apps Script (Advanced):</strong>
                        <ul style="margin: 0.25rem 0 0 1.25rem; line-height: 1.6; font-size: 0.8125rem;">
                            <li>Full two-way sync</li>
                            <li>Edit from Game Library</li>
                            <li>Requires Apps Script setup</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCloudModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveCloudSettings()">üíæ Save & Load Data</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal" style="z-index: 10000; display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">üéÆ Game Library Login</h2>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-light); margin-bottom: 1.5rem; text-align: center;">
                    Sign in to sync your games across all devices
                </p>

                <!-- Login Form -->
                <form id="loginForm" onsubmit="handleLogin(event)" style="display: block;">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required 
                               placeholder="your@email.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" required 
                               placeholder="Your password" autocomplete="current-password">
                    </div>
                    <div id="loginError" style="display: none; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; color: #ef4444; font-size: 0.875rem; margin-bottom: 1rem;"></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;" id="loginBtn">
                        üîê Sign In
                    </button>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="showSignupForm()">
                        Create Account
                    </button>
                </form>

                <!-- Signup Form -->
                <form id="signupForm" onsubmit="handleSignup(event)" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="signupEmail" required 
                               placeholder="your@email.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="signupPassword" required 
                               placeholder="Choose a password" autocomplete="new-password" minlength="6">
                        <small style="color: var(--text-light); font-size: 0.75rem;">At least 6 characters</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-input" id="signupPasswordConfirm" required 
                               placeholder="Confirm password" autocomplete="new-password" minlength="6">
                    </div>
                    <div id="signupError" style="display: none; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; color: #ef4444; font-size: 0.875rem; margin-bottom: 1rem;"></div>
                    <button type="submit" class="btn btn-success" style="width: 100%; margin-bottom: 0.5rem;" id="signupBtn">
                        ‚ú® Create Account
                    </button>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="showLoginForm()">
                        Back to Sign In
                    </button>
                </form>

                <!-- OR Divider -->
                <div style="text-align: center; margin: 1.5rem 0; position: relative;">
                    <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.1);">
                    <span style="position: absolute; top: -0.625rem; left: 50%; transform: translateX(-50%); background: var(--card-background); padding: 0 1rem; color: var(--text-light); font-size: 0.875rem;">OR</span>
                </div>

                <!-- Local Storage Mode -->
                <button type="button" class="btn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="useLocalStorageMode()">
                    üíæ Use Local Storage Only
                </button>
                <small style="display: block; text-align: center; color: var(--text-light); font-size: 0.75rem; margin-top: 0.5rem;">
                    No sync, data stays on this device
                </small>
            </div>
        </div>
    </div>

    <!-- Tracker Preview Modal -->
    <div class="tracker-modal" id="trackerModal">
        <div class="tracker-modal-content">
            <div class="tracker-modal-header">
                <h2 class="tracker-modal-title" id="trackerModalTitle">Game Tracker</h2>
                <button class="tracker-modal-close" onclick="closeTrackerModal()">√ó</button>
            </div>
            <div class="tracker-modal-body">
                <iframe id="trackerIframe" class="tracker-iframe"></iframe>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // FIREBASE CONFIGURATION
        // ========================================================================
        
        // PASTE YOUR FIREBASE CONFIG HERE
        // Get this from: Firebase Console ‚Üí Project Settings ‚Üí Your apps ‚Üí Web app
        const firebaseConfig = {
		apiKey: "AIzaSyCYR1pKLa99k6ADLk5QSYJ4XFlzyiF-8G0",
		authDomain: "game-library-741fb.firebaseapp.com",
		databaseURL: "https://game-library-741fb-default-rtdb.firebaseio.com",
		projectId: "game-library-741fb",
		storageBucket: "game-library-741fb.firebasestorage.app",
		messagingSenderId: "766308043698",
		appId: "1:766308043698:web:8a57160441534dd9fdf2ab"
		};
        
        // Initialize Firebase
        let firebaseInitialized = false;
        let database = null;
        let auth = null;
        let currentUser = null;
        let isAuthenticated = false;
        let useLocalStorageOnly = false;
        
        // ========================================================================
        // iOS COMPATIBILITY CHECK
        // ========================================================================
        
        function isIOSSafari() {
            const ua = navigator.userAgent;
            const iOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
            return iOS;
        }
        
        function checkStorageAvailability() {
            return new Promise((resolve) => {
                // Test if IndexedDB is available (required for Firebase)
                if (!window.indexedDB) {
                    console.warn('‚ö†Ô∏è IndexedDB not available');
                    resolve(false);
                    return;
                }
                
                // Test if we can actually use it (private browsing check)
                try {
                    const testDB = window.indexedDB.open('test');
                    testDB.onerror = () => {
                        console.warn('‚ö†Ô∏è IndexedDB access blocked (likely private browsing)');
                        resolve(false);
                    };
                    testDB.onsuccess = () => {
                        testDB.result.close();
                        window.indexedDB.deleteDatabase('test');
                        resolve(true);
                    };
                    // Timeout after 1 second
                    setTimeout(() => resolve(false), 1000);
                } catch (e) {
                    console.warn('‚ö†Ô∏è IndexedDB test failed:', e);
                    resolve(false);
                }
            });
        }
        
        // Check environment and decide storage strategy
        async function initializeStorage() {
            const isIOS = isIOSSafari();
            const storageAvailable = await checkStorageAvailability();
            
            if (isIOS) {
                console.log('üì± iOS device detected');
            }
            
            if (!storageAvailable) {
                console.log('üíæ IndexedDB unavailable - using localStorage only');
                useLocalStorageOnly = true;
                updateAuthStatus(false);
                loadFromLocalStorage();
                hideLoginModal();
                return;
            }
            
            // Try to initialize Firebase (all platforms)
            try {
                if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    auth = firebase.auth();
                    
                    // Set persistence to LOCAL (survives browser restarts)
                    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    
                    firebaseInitialized = true;
                    console.log('‚úÖ Firebase initialized successfully');
                    
                    // Set up authentication (will show login modal if not signed in)
                    initializeAuth();
                } else {
                    console.log('‚ö†Ô∏è Firebase not configured. Using localStorage only.');
                    useLocalStorageOnly = true;
                    updateAuthStatus(false);
                    loadFromLocalStorage();
                    hideLoginModal();
                }
            } catch (error) {
                console.error('‚ùå Firebase initialization failed:', error);
                console.log('üíæ Falling back to localStorage only');
                useLocalStorageOnly = true;
                updateAuthStatus(false);
                loadFromLocalStorage();
                hideLoginModal();
            }
        }
        
        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const savedGames = localStorage.getItem('gameLibraryData');
                if (savedGames) {
                    games = JSON.parse(savedGames);
                    console.log(`‚úÖ Loaded ${games.length} games from localStorage`);
                    displayGames();
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
            }
        }
        
        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('gameLibraryData', JSON.stringify(games));
                console.log('‚úÖ Saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }
        
        // ========================================================================
        // AUTHENTICATION
        // ========================================================================
        
        async function initializeAuth() {
            if (useLocalStorageOnly) {
                console.log('üíæ Skipping Firebase auth - using localStorage only');
                hideLoginModal();
                return;
            }
            
            // Show loading state initially
            console.log('üîÑ Checking authentication status...');
            
            // Listen for auth state changes
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in (either from cache or fresh login)
                    currentUser = user;
                    isAuthenticated = true;
                    console.log('üîê User authenticated:', user.email || user.uid);
                    updateAuthStatus(true, user.email);
                    hideLoginModal();
                    
                    // Now initialize Firebase sync
                    initializeFirebase();
                } else {
                    // No user session found, show login modal
                    console.log('üîì No user session found, showing login...');
                    // Small delay to ensure DOM is ready
                    setTimeout(() => {
                        showLoginModal();
                    }, 100);
                }
            });
        }
        
        // Login form handlers
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
        }
        
        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
        }
        
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
                console.log('üìã Login modal shown');
            }
        }
        
        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
                console.log('‚úÖ Login modal hidden');
            }
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'üîÑ Signing in...';
            loginError.style.display = 'none';
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Login successful');
                // Auth state change will trigger automatically
            } catch (error) {
                console.error('‚ùå Login failed:', error);
                loginError.textContent = getAuthErrorMessage(error.code);
                loginError.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = 'üîê Sign In';
            }
        }
        
        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            const signupBtn = document.getElementById('signupBtn');
            const signupError = document.getElementById('signupError');
            
            signupError.style.display = 'none';
            
            // Validate passwords match
            if (password !== passwordConfirm) {
                signupError.textContent = 'Passwords do not match';
                signupError.style.display = 'block';
                return;
            }
            
            signupBtn.disabled = true;
            signupBtn.textContent = 'üîÑ Creating account...';
            
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                console.log('‚úÖ Account created successfully');
                // Auth state change will trigger automatically
            } catch (error) {
                console.error('‚ùå Signup failed:', error);
                signupError.textContent = getAuthErrorMessage(error.code);
                signupError.style.display = 'block';
                signupBtn.disabled = false;
                signupBtn.textContent = '‚ú® Create Account';
            }
        }
        
        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/email-already-in-use':
                    return 'This email is already registered. Please sign in instead.';
                case 'auth/invalid-email':
                    return 'Invalid email address format.';
                case 'auth/user-not-found':
                    return 'No account found with this email. Please sign up.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later.';
                case 'auth/network-request-failed':
                    return 'Network error. Please check your connection.';
                default:
                    return `Error: ${errorCode}. Please try again.`;
            }
        }
        
        function useLocalStorageMode() {
            console.log('üíæ User chose localStorage mode');
            useLocalStorageOnly = true;
            updateAuthStatus(false);
            hideLoginModal();
            loadFromLocalStorage();
            updateUI();
        }
        
        async function handleLogout() {
            if (!auth || useLocalStorageOnly) return;
            
            try {
                await auth.signOut();
                console.log('‚úÖ Logged out successfully');
                games = [];
                updateUI();
            } catch (error) {
                console.error('‚ùå Logout failed:', error);
            }
        }
        
        function updateAuthStatus(authenticated, userEmail = null) {
            const statusIndicator = document.getElementById('authStatus');
            if (!statusIndicator) return;
            
            if (authenticated && userEmail) {
                statusIndicator.innerHTML = `üîí ${userEmail} <button onclick="handleLogout()" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.25rem; color: white; cursor: pointer; font-size: 0.75rem;">Logout</button>`;
                statusIndicator.style.color = '#10b981';
                statusIndicator.title = 'Signed in with Firebase - Data syncing';
            } else if (authenticated) {
                statusIndicator.innerHTML = 'üîí Secure';
                statusIndicator.style.color = '#10b981';
                statusIndicator.title = 'Connected to Firebase with authentication';
            } else {
                statusIndicator.innerHTML = 'üíæ Local';
                statusIndicator.style.color = '#f59e0b';
                statusIndicator.title = 'Using local storage only';
            }
        }
        
        // Check if current user can write (for UI updates)
        function canUserWrite() {
            return isAuthenticated && currentUser !== null;
        }
        
        // ========================================================================
        // DATA STORAGE
        // ========================================================================
        
        // Data storage
        let games = [];
        let currentFilter = 'all';
        let currentEditId = null;
        let cloudApiUrl = localStorage.getItem('cloudApiUrl') || '';
        let cloudSyncEnabled = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize storage (checks for iOS/private browsing and decides strategy)
            await initializeStorage();
            
            // If using localStorage only, we're done initializing
            if (useLocalStorageOnly) {
                console.log('üíæ Ready with localStorage mode');
                updateUI();
                
                // Check for CSV cloud sync
                if (cloudApiUrl) {
                    cloudSyncEnabled = true;
                    loadFromCloud();
                }
            } else if (firebaseInitialized) {
                console.log('üî• Firebase enabled - waiting for authentication...');
                // Auth will trigger initializeFirebase() when ready
            }
            
            // Listen for messages from tracker iframe
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'TRACKER_SYNC') {
                    console.log('Received tracker sync:', event.data);
                    handleTrackerSync(event.data);
                }
                
                if (event.data && event.data.type === 'TRACKER_PROGRESS_UPDATE') {
                    console.log('Received tracker progress update:', event.data);
                    handleTrackerProgressUpdate(event.data);
                }
            });
        });

        // Handle tracker progress updates (checkboxes)
        function handleTrackerProgressUpdate(data) {
            const gameId = data.gameId;
            const game = games.find(g => g.id == gameId);
            
            if (!game) {
                console.error('Game not found:', gameId);
                return;
            }

            // Update tracker progress
            if (!game.trackerProgress) {
                game.trackerProgress = {};
            }
            
            game.trackerProgress = data.allProgress;
            
            // Save locally
            saveGames();
            
            // Save to Firebase if enabled
            if (firebaseInitialized) {
                saveGameToFirebase(game);
                console.log('‚úÖ Tracker progress synced to Firebase');
            }
        }

        // Firebase initialization and real-time sync
        function initializeFirebase() {
            if (!currentUser) {
                console.error('‚ùå Cannot initialize Firebase - no user');
                return;
            }
            
            console.log('üîÑ Initializing Firebase sync for user:', currentUser.uid);
            console.log('üìç Firebase path: users/' + currentUser.uid + '/games');
            
            const userGamesRef = database.ref(`users/${currentUser.uid}/games`);
            
            // Listen for real-time updates
            userGamesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                console.log('üì¶ Firebase data received:', data ? Object.keys(data).length : 0, 'games');
                console.log('üì¶ Raw data keys:', data ? Object.keys(data) : 'null');
                
                if (data) {
                    games = Object.keys(data).map(key => {
                        const game = data[key];
                        return {
                            id: game.id || key,
                            title: game.title,
                            icon: game.icon || 'üéÆ',
                            imageUrl: game.imageUrl || null,
                            platform: game.platform,
                            status: game.status,
                            startDate: game.startDate,
                            hours: parseInt(game.hours) || 0,
                            progress: parseInt(game.progress) || 0,
                            currentlyPlaying: game.currentlyPlaying === true || game.currentlyPlaying === 'true',
                            quote: game.quote,
                            notes: game.notes,
                            trackerUrl: game.trackerUrl || null,
                            trackerProgress: game.trackerProgress || {}
                        };
                    });
                    console.log('‚úÖ Processed games:', games.length);
                    console.log('üéÆ Game titles:', games.map(g => g.title));
                } else {
                    console.log('‚ö†Ô∏è No games found in Firebase');
                    games = [];
                }
                
                saveGames(); // Backup to localStorage
                console.log('üíæ Saved to localStorage');
                
                // Force UI update
                console.log('üñºÔ∏è Updating UI...');
                updateStats();
                updateHero();
                renderGames();
                
                console.log('üìä Synced from Firebase:', games.length, 'games');
                console.log('‚úÖ UI update complete');
            }, (error) => {
                console.error('‚ùå Firebase sync error:', error);
                console.log('üíæ Falling back to localStorage');
                loadFromLocalStorage();
                updateUI();
            });
            
            // Handle connection state
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    console.log('üü¢ Connected to Firebase');
                } else {
                    console.log('üî¥ Disconnected from Firebase');
                }
            });
        }

        // Save game to Firebase
        async function saveGameToFirebase(game) {
            if (!firebaseInitialized || useLocalStorageOnly) {
                // Already saved to localStorage by saveGames()
                return;
            }
            
            if (!canUserWrite()) {
                console.warn('‚ö†Ô∏è Cannot write to Firebase - not authenticated');
                return;
            }
            
            console.log('üî• Saving to Firebase - Before sanitization:');
            console.log('  imageUrl:', game.imageUrl);
            console.log('  trackerUrl:', game.trackerUrl);
            console.log('  imageData exists:', !!game.imageData);
            console.log('  trackerHtml exists:', !!game.trackerHtml);
            
            try {
                // Sanitize game object to prevent NaN/undefined/null issues
                const sanitizedGame = {
                    ...game,
                    hours: parseInt(game.hours) || 0,
                    progress: parseInt(game.progress) || 0
                };
                
                console.log('üî• After sanitization:');
                console.log('  imageUrl:', sanitizedGame.imageUrl);
                console.log('  trackerUrl:', sanitizedGame.trackerUrl);
                
                // Remove any NaN values from nested objects
                if (sanitizedGame.trackerProgress) {
                    sanitizedGame.trackerProgress = JSON.parse(
                        JSON.stringify(sanitizedGame.trackerProgress, (key, value) => {
                            // Replace NaN, undefined, and null with appropriate defaults
                            if (typeof value === 'number' && isNaN(value)) return 0;
                            if (value === undefined || value === null) return null;
                            return value;
                        })
                    );
                }
                
                console.log('üî• Final object being sent to Firebase:', JSON.stringify({
                    id: sanitizedGame.id,
                    title: sanitizedGame.title,
                    imageUrl: sanitizedGame.imageUrl,
                    trackerUrl: sanitizedGame.trackerUrl,
                    hasImageData: !!sanitizedGame.imageData,
                    hasTrackerHtml: !!sanitizedGame.trackerHtml
                }, null, 2));
                
                await database.ref(`users/${currentUser.uid}/games/${game.id}`).set(sanitizedGame);
                console.log('‚úÖ Game saved to Firebase:', game.title);
            } catch (error) {
                console.error('‚ùå Failed to save to Firebase:', error);
            }
        }

        // Delete game from Firebase
        async function deleteGameFromFirebase(gameId) {
            if (!firebaseInitialized || useLocalStorageOnly) return;
            
            if (!canUserWrite()) {
                console.warn('‚ö†Ô∏è Cannot delete from Firebase - not authenticated');
                return;
            }
            
            try {
                await database.ref(`users/${currentUser.uid}/games/${gameId}`).remove();
                console.log('‚úÖ Game deleted from Firebase:', gameId);
            } catch (error) {
                console.error('‚ùå Failed to delete from Firebase:', error);
            }
        }

        // Update cloud sync button to show status
        function updateCloudSyncButton() {
            const btn = document.getElementById('cloudSyncBtn');
            if (!btn) return;
            
            if (firebaseInitialized) {
                btn.innerHTML = 'üî• Firebase';
                btn.style.background = 'linear-gradient(135deg, #FF6B6B, #4ECDC4)';
                btn.style.color = 'white';
                btn.title = 'Firebase Real-Time Sync Active';
            } else if (cloudSyncEnabled) {
                btn.innerHTML = '‚òÅÔ∏è CSV Sync';
                btn.title = 'CSV Cloud Sync Active';
            } else {
                btn.innerHTML = '‚òÅÔ∏è Cloud Sync';
                btn.title = 'Configure Cloud Sync';
            }
        }

        // Cloud sync functions
        function handleCloudSyncClick() {
            console.log('üîò Cloud Sync button clicked!');
            console.log('Firebase initialized:', firebaseInitialized);
            console.log('Authenticated:', isAuthenticated);
            console.log('Current user:', currentUser);
            
            alert('Button clicked! Check console for details.');
            
            if (firebaseInitialized && isAuthenticated) {
                // Force Firebase sync
                console.log('üîÑ Force syncing from Firebase...');
                alert('Starting Firebase sync...');
                
                const userGamesRef = database.ref(`users/${currentUser.uid}/games`);
                userGamesRef.once('value', (snapshot) => {
                    const data = snapshot.val();
                    console.log('üì¶ Manual sync - found:', data ? Object.keys(data).length : 0, 'games');
                    
                    if (data) {
                        games = Object.keys(data).map(key => {
                            const game = data[key];
                            return {
                                id: game.id || key,
                                title: game.title,
                                icon: game.icon || 'üéÆ',
                                imageUrl: game.imageUrl || null,
                                platform: game.platform,
                                status: game.status,
                                startDate: game.startDate,
                                hours: parseInt(game.hours) || 0,
                                progress: parseInt(game.progress) || 0,
                                currentlyPlaying: game.currentlyPlaying === true || game.currentlyPlaying === 'true',
                                quote: game.quote,
                                notes: game.notes,
                                trackerUrl: game.trackerUrl || null,
                                trackerProgress: game.trackerProgress || {}
                            };
                        });
                        
                        console.log('‚úÖ Processed games array:', games.length);
                        
                        // Save to localStorage
                        saveGames();
                        
                        // Force complete UI refresh
                        updateStats();
                        updateHero();
                        renderGames();
                        
                        console.log('‚úÖ UI updated');
                        alert(`‚úÖ Synced ${games.length} games from Firebase!`);
                    } else {
                        alert('‚ö†Ô∏è No games found in Firebase');
                    }
                }).catch(error => {
                    console.error('‚ùå Manual sync failed:', error);
                    alert('‚ùå Sync failed: ' + error.message);
                });
            } else {
                alert('Not authenticated. Opening cloud settings...');
                openCloudSettings();
            }
        }
        
        function openCloudSettings() {
            document.getElementById('cloudApiUrl').value = cloudApiUrl;
            document.getElementById('cloudModal').classList.add('active');
        }

        function closeCloudModal() {
            document.getElementById('cloudModal').classList.remove('active');
        }

        function saveCloudSettings() {
            const url = document.getElementById('cloudApiUrl').value.trim();
            
            if (!url) {
                showCloudStatus('Please enter an API URL', 'error');
                return;
            }
            
            cloudApiUrl = url;
            localStorage.setItem('cloudApiUrl', url);
            cloudSyncEnabled = true;
            
            showCloudStatus('Settings saved! Testing connection...', 'info');
            
            // Test connection
            testCloudConnection();
        }

        function testCloudConnection() {
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            
            if (isCsvUrl) {
                // CSV test
                showCloudStatus('Testing CSV connection...', 'info');
                
                fetch(cloudApiUrl)
                    .then(response => response.text())
                    .then(csvText => {
                        const lines = csvText.split('\n').filter(line => line.trim());
                        if (lines.length >= 1) {
                            const dataRows = lines.length - 1;
                            showCloudStatus(`‚úì Connected! Found ${dataRows} games in cloud. (Read-Only CSV Method)`, 'success');
                            setTimeout(() => {
                                loadFromCloud();
                            }, 2000);
                        } else {
                            showCloudStatus('Connected but no data found.', 'error');
                        }
                    })
                    .catch(error => {
                        showCloudStatus('Connection failed: ' + error.message, 'error');
                    });
            } else {
                // Apps Script JSONP test
                showCloudStatus('Testing Apps Script connection...', 'info');
                
                const callbackName = 'testCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success) {
                        showCloudStatus(`‚úì Connected! Found ${data.games?.length || 0} games. (Full Sync Enabled)`, 'success');
                        setTimeout(() => {
                            loadFromCloud();
                        }, 2000);
                    } else {
                        showCloudStatus('Connection failed: ' + (data.error || 'Unknown error'), 'error');
                    }
                };
                
                const url = cloudApiUrl + (cloudApiUrl.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    showCloudStatus('Connection failed. Make sure the Apps Script is deployed correctly.', 'error');
                };
                
                document.body.appendChild(script);
            }
        }

        function showCloudStatus(message, type) {
            const status = document.getElementById('cloudStatus');
            status.style.display = 'block';
            status.textContent = message;
            
            if (type === 'success') {
                status.style.background = 'var(--success)';
                status.style.color = 'white';
            } else if (type === 'error') {
                status.style.background = 'var(--danger)';
                status.style.color = 'white';
            } else {
                status.style.background = 'var(--warning)';
                status.style.color = 'white';
            }
        }

        async function loadFromCloud() {
            if (!cloudApiUrl) return;
            
            // Check if this is a CSV URL or Apps Script URL
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            
            if (isCsvUrl) {
                // CSV method
                return loadFromCloudCSV();
            } else {
                // Apps Script JSONP method
                return loadFromCloudJSONP();
            }
        }
        
        async function loadFromCloudCSV() {
            try {
                console.log('Loading from cloud (CSV):', cloudApiUrl);
                const response = await fetch(cloudApiUrl);
                const csvText = await response.text();
                
                console.log('Received CSV data, parsing...');
                
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    console.log('No data in CSV');
                    return;
                }
                
                const headers = parseCSVLine(lines[0]);
                console.log('Headers:', headers);
                
                const parsedGames = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values[0]) {
                        const game = {};
                        headers.forEach((header, index) => {
                            game[header] = values[index] || '';
                        });
                        parsedGames.push(game);
                    }
                }
                
                console.log('Parsed', parsedGames.length, 'games from CSV');
                
                games = parsedGames.map(game => ({
                    id: game.id,
                    title: game.title,
                    icon: game.icon || 'üéÆ',
                    imageUrl: game.imageUrl || null,
                    platform: game.platform,
                    status: game.status,
                    startDate: game.startDate,
                    hours: parseInt(game.hours) || 0,
                    progress: parseInt(game.progress) || 0,
                    currentlyPlaying: game.currentlyPlaying === 'TRUE' || game.currentlyPlaying === 'true',
                    quote: game.quote,
                    notes: game.notes,
                    trackerUrl: game.trackerUrl || null,
                    trackerProgress: game.trackerProgress || {}
                }));
                
                saveGames();
                updateUI();
                console.log('Successfully loaded', games.length, 'games from cloud (CSV)');
                
            } catch (error) {
                console.error('Failed to load from cloud (CSV):', error);
            }
        }
        
        async function loadFromCloudJSONP() {
            return new Promise((resolve, reject) => {
                console.log('Loading from cloud (JSONP):', cloudApiUrl);
                
                const callbackName = 'gameLibraryCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success && data.games) {
                        games = data.games.map(game => ({
                            id: game.id,
                            title: game.title,
                            icon: game.icon || 'üéÆ',
                            imageUrl: game.imageUrl || null,
                            platform: game.platform,
                            status: game.status,
                            startDate: game.startDate,
                            hours: parseInt(game.hours) || 0,
                            progress: parseInt(game.progress) || 0,
                            currentlyPlaying: game.currentlyPlaying === 'TRUE' || game.currentlyPlaying === true,
                            quote: game.quote,
                            notes: game.notes,
                            trackerUrl: game.trackerUrl || null,
                            trackerProgress: game.trackerProgress || {}
                        }));
                        
                        saveGames();
                        updateUI();
                        console.log('Successfully loaded', games.length, 'games from cloud (JSONP)');
                        resolve();
                    } else {
                        reject(new Error('Invalid response'));
                    }
                };
                
                const url = cloudApiUrl + (cloudApiUrl.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Failed to load script'));
                };
                
                document.body.appendChild(script);
            });
        }
        
        // Helper function to parse CSV line (handles quotes)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result;
        }

        async function syncToCloud() {
            if (!cloudApiUrl) {
                alert('Please configure Cloud Sync settings first');
                openCloudSettings();
                return;
            }
            
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            
            if (isCsvUrl) {
                alert('Cloud sync is read-only when using CSV publishing.\n\nTo update your game library:\n1. Edit the Google Sheet directly\n2. Changes appear automatically in Game Library\n3. Refresh this page to see updates');
                return;
            }
            
            // Apps Script method with JSONP
            showCloudStatus('Syncing ' + games.length + ' games to cloud...', 'info');
            
            return new Promise((resolve, reject) => {
                const callbackName = 'syncCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success) {
                        showCloudStatus('‚úì Successfully synced to cloud!', 'success');
                        
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-lg); z-index: 10000;';
                        notification.innerHTML = '‚òÅÔ∏è Synced ' + games.length + ' games to cloud!';
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 3000);
                        resolve();
                    } else {
                        showCloudStatus('Sync failed: ' + (data.error || 'Unknown error'), 'error');
                        reject(new Error(data.error));
                    }
                };
                
                const payload = encodeURIComponent(JSON.stringify({
                    action: 'sync_all',
                    games: games,
                    callback: callbackName
                }));
                
                // For JSONP POST simulation, we need to use GET with data in URL
                // This is a limitation - large data might hit URL length limits
                const url = cloudApiUrl + '?callback=' + callbackName + '&data=' + payload;
                
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    showCloudStatus('Sync failed: Network error', 'error');
                    reject(new Error('Network error'));
                };
                
                document.body.appendChild(script);
            });
        }

        async function saveGameToCloud(game) {
            if (!cloudSyncEnabled || !cloudApiUrl) return;
            
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            if (isCsvUrl) {
                console.log('Note: CSV is read-only - edit the Google Sheet directly');
                return;
            }
            
            // JSONP method for single game save
            return new Promise((resolve, reject) => {
                const callbackName = 'saveCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success) {
                        console.log('Game synced to cloud:', game.title);
                        resolve();
                    } else {
                        console.error('Failed to sync game:', data.error);
                        reject(new Error(data.error));
                    }
                };
                
                const payload = encodeURIComponent(JSON.stringify({
                    action: 'save',
                    game: game,
                    callback: callbackName
                }));
                
                const url = cloudApiUrl + '?callback=' + callbackName + '&data=' + payload;
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Network error'));
                };
                
                document.body.appendChild(script);
            });
        }

        async function deleteGameFromCloud(gameId) {
            if (!cloudSyncEnabled || !cloudApiUrl) return;
            
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            if (isCsvUrl) {
                console.log('Note: CSV is read-only - edit the Google Sheet directly');
                return;
            }
            
            // JSONP method for delete
            return new Promise((resolve, reject) => {
                const callbackName = 'deleteCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success) {
                        console.log('Game deleted from cloud:', gameId);
                        resolve();
                    } else {
                        console.error('Failed to delete game:', data.error);
                        reject(new Error(data.error));
                    }
                };
                
                const payload = encodeURIComponent(JSON.stringify({
                    action: 'delete',
                    gameId: gameId,
                    callback: callbackName
                }));
                
                const url = cloudApiUrl + '?callback=' + callbackName + '&data=' + payload;
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Network error'));
                };
                
                document.body.appendChild(script);
            });
        }

        // Handle tracker sync data
        function handleTrackerSync(data) {
            const gameId = data.gameId;
            const game = games.find(g => g.id == gameId);
            
            if (!game) {
                console.error('Game not found:', gameId);
                alert('Error: Could not find game to update');
                return;
            }

            // Update game data
            const oldHours = game.hours;
            const oldProgress = game.progress;
            
            if (data.hours !== undefined) {
                game.hours = parseInt(data.hours);
            }
            if (data.progress !== undefined) {
                game.progress = parseInt(data.progress);
            }

            // Save and update UI
            saveGames();
            updateUI();
            
            // Sync to Firebase or cloud if enabled
            if (firebaseInitialized) {
                saveGameToFirebase(game);
            } else if (cloudSyncEnabled) {
                saveGameToCloud(game);
            }

            // Show success notification
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-lg); z-index: 10000; animation: slideInRight 0.3s;';
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.25rem;">‚úì Synced from Tracker${firebaseInitialized ? ' to Firebase' : cloudSyncEnabled ? ' & Cloud' : ''}</div>
                <div style="font-size: 0.875rem;">
                    ${data.hours !== undefined ? `Hours: ${oldHours} ‚Üí ${game.hours}` : ''}
                    ${data.hours !== undefined && data.progress !== undefined ? '<br>' : ''}
                    ${data.progress !== undefined ? `Progress: ${oldProgress}% ‚Üí ${game.progress}%` : ''}
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);

            console.log('Game updated:', game);
        }

        // Handle image upload
        // Handle image URL input - auto preview
        document.addEventListener('DOMContentLoaded', function() {
            const imageUrlInput = document.getElementById('gameImageUrl');
            if (imageUrlInput) {
                imageUrlInput.addEventListener('input', function() {
                    const url = this.value.trim();
                    if (url) {
                        document.getElementById('previewImg').src = url;
                        document.getElementById('imagePreview').style.display = 'block';
                    } else {
                        document.getElementById('imagePreview').style.display = 'none';
                    }
                });
            }
        });
        
        // Remove image
        function removeImage() {
            document.getElementById('gameImageUrl').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        // Open tracker in modal
        function openTracker(id) {
            const game = games.find(g => g.id == id);
            if (!game) {
                alert('Game not found.');
                return;
            }
            
            // Check if tracker URL is set
            if (!game.trackerUrl || game.trackerUrl.trim() === '') {
                alert('No tracker URL set for this game. Edit the game and add a tracker URL.');
                return;
            }

            document.getElementById('trackerModalTitle').textContent = `${game.icon} ${game.title} - Tracker`;
            const iframe = document.getElementById('trackerIframe');
            
            console.log('üìç Loading external tracker:', game.trackerUrl);
            
            // Build URL with progress data as hash
            const progressData = encodeURIComponent(JSON.stringify(game.trackerProgress || {}));
            const trackerUrl = new URL(game.trackerUrl);
            trackerUrl.hash = `gameId=${game.id}&progress=${progressData}`;
            
            // Load external tracker
            iframe.src = trackerUrl.toString();
            
            // Setup message listener for sync from external tracker
            window.addEventListener('message', function externalTrackerSync(event) {
                if (event.data && event.data.type === 'TRACKER_PROGRESS_UPDATE' && event.data.gameId === game.id) {
                    console.log('üìä Received progress update from external tracker');
                    handleTrackerProgressUpdate(event.data);
                }
            });
            
            document.getElementById('trackerModal').classList.add('active');
        }

        // Close tracker modal
        function closeTrackerModal() {
            document.getElementById('trackerModal').classList.remove('active');
            document.getElementById('trackerIframe').srcdoc = '';
        }

        // Load games from localStorage
        function loadGames() {
            const stored = localStorage.getItem('gameLibrary');
            if (stored) {
                games = JSON.parse(stored);
            } else {
                // Sample data
                games = [
                    {
                        id: Date.now() + 1,
                        title: 'Final Fantasy XVI',
                        icon: '‚öîÔ∏è',
                        platform: 'PlayStation',
                        status: 'playing',
                        startDate: '2025-01-01',
                        hours: 32,
                        progress: 47,
                        currentlyPlaying: true,
                        quote: 'The legacy of the Crystals has shaped our history for long enough.',
                        notes: 'Amazing combat system!'
                    },
                    {
                        id: Date.now() + 2,
                        title: 'Elden Ring',
                        icon: 'üó°Ô∏è',
                        platform: 'PC',
                        status: 'completed',
                        startDate: '2024-12-15',
                        hours: 82,
                        progress: 100,
                        currentlyPlaying: false,
                        quote: 'Rise, Tarnished.',
                        notes: 'Best FromSoftware game yet!'
                    }
                ];
                saveGames();
            }
        }

        // Save games to localStorage
        function saveGames() {
            try {
                localStorage.setItem('gameLibrary', JSON.stringify(games));
                console.log('üíæ Saved to localStorage successfully');
            } catch (error) {
                console.warn('‚ö†Ô∏è localStorage save failed:', error.message);
                console.log('üíæ Continuing without localStorage backup...');
                // Don't throw error - continue with Firebase sync
            }
        }

        // Update entire UI
        function updateUI() {
            updateStats();
            updateHero();
            renderGames();
        }

        // Update statistics
        function updateStats() {
            const total = games.length;
            const completed = games.filter(g => g.status === 'completed').length;
            const inProgress = games.filter(g => g.status === 'playing').length;
            const totalHours = games.reduce((sum, g) => sum + (g.hours || 0), 0);

            document.getElementById('totalGames').textContent = total;
            document.getElementById('completedGames').textContent = completed;
            document.getElementById('inProgressGames').textContent = inProgress;
            document.getElementById('totalHours').textContent = totalHours;
        }

        // Update hero section
        function updateHero() {
            const hero = document.getElementById('heroSection');
            const currentGame = games.find(g => g.currentlyPlaying);

            console.log('Updating hero. Current game:', currentGame?.title, 'Has tracker:', !!currentGame?.trackerUrl);
            
            // Update cloud sync button status
            updateCloudSyncButton();

            if (currentGame) {
                // Use imageUrl only
                const backgroundStyle = currentGame.imageUrl
                    ? `background-image: url('${currentGame.imageUrl}');` 
                    : '';
                const heroClass = currentGame.imageUrl ? 'has-image' : '';
                    
                hero.setAttribute('style', backgroundStyle);
                hero.className = `hero ${heroClass}`;
                hero.innerHTML = `
                    <div class="hero-content">
                        <div class="hero-badge">üéÆ Currently Playing</div>
                        <h1 class="hero-title">${currentGame.imageUrl ? '' : currentGame.icon} ${currentGame.title}</h1>
                        <p class="hero-subtitle">${currentGame.quote || 'An epic gaming journey awaits!'}</p>
                        <div class="hero-meta">
                            <div class="hero-meta-item">‚è±Ô∏è ${currentGame.hours} hours played</div>
                            <div class="hero-meta-item">üìä ${currentGame.progress}% complete</div>
                            <div class="hero-meta-item">üéØ ${currentGame.platform}</div>
                            ${currentGame.trackerUrl ? '<div class="hero-meta-item">üîó Has Tracker</div>' : ''}
                        </div>
                        <div class="hero-actions">
                            ${currentGame.trackerUrl ? `<button class="btn btn-primary" onclick="openTracker('${currentGame.id}')">üìä Open Tracker</button>` : ''}
                            <button class="btn ${currentGame.trackerUrl ? 'btn-secondary' : 'btn-primary'}" onclick="editGame('${currentGame.id}')">Update Progress</button>
                        </div>
                    </div>
                `;
            } else {
                hero.innerHTML = `
                    <div class="hero-empty">
                        <div class="hero-empty-icon">üéÆ</div>
                        <h2>No Game Currently Playing</h2>
                        <p style="opacity: 0.7; margin-bottom: 1.5rem;">Add a game and mark it as "Currently Playing" to see it here</p>
                        <button class="btn btn-primary" onclick="openAddModal()">Add Your First Game</button>
                    </div>
                `;
            }
        }

        // Render games grid
        function renderGames() {
            const grid = document.getElementById('gamesGrid');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = games.filter(game => {
                const matchesSearch = game.title.toLowerCase().includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || game.status === currentFilter;
                return matchesSearch && matchesFilter;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">üéØ</div>
                        <h3 class="empty-title">No Games Found</h3>
                        <p class="empty-text">Try adjusting your search or filters</p>
                        <button class="btn btn-primary" onclick="openAddModal()">Add New Game</button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(game => {
                // Use imageUrl only
                const headerStyle = game.imageUrl
                    ? `background-image: url('${game.imageUrl}');` 
                    : '';
                const headerClass = game.imageUrl ? 'game-header has-image' : 'game-header';
                
                // Check if game has tracker URL
                const hasTracker = game.trackerUrl && game.trackerUrl.trim() !== '';
                
                // Tracker badge
                const trackerBadge = hasTracker 
                    ? '<div class="tracker-badge" style="background: linear-gradient(135deg, #667eea, #764ba2);">üîó Tracker</div>' 
                    : '';
                    
                return `
                <div class="game-card" onclick="viewGameDetails('${game.id}')">
                    <div class="${headerClass}" style="${headerStyle}">
                        <div class="game-status-badge">${getStatusLabel(game.status)}</div>
                        ${game.imageUrl ? '' : `<div class="game-icon">${game.icon || 'üéÆ'}</div>`}
                    </div>
                    <div class="game-body">
                        <h3 class="game-title">${game.title}</h3>
                        ${trackerBadge}
                        <div class="game-meta">
                            <div class="game-meta-item">üéØ ${game.platform}</div>
                            <div class="game-meta-item">‚è±Ô∏è ${game.hours}h</div>
                            <div class="game-meta-item">üìÖ ${formatDate(game.startDate)}</div>
                            <div class="game-meta-item">${game.currentlyPlaying ? 'üéÆ Playing' : ''}</div>
                        </div>
                        <div class="progress-section">
                            <div class="progress-label">
                                <span>Progress</span>
                                <span>${game.progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${game.progress}%"></div>
                            </div>
                        </div>
                        <div class="game-actions-extended" onclick="event.stopPropagation()">
                            ${hasTracker ? `<button class="game-btn" onclick="openTracker('${game.id}')">üìä Tracker</button>` : ''}
                            <button class="game-btn" onclick="editGame('${game.id}')">‚úèÔ∏è Edit</button>
                            <button class="game-btn" onclick="deleteGame('${game.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Filter games
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderGames();
        }

        function filterGames() {
            renderGames();
        }

        // Sort games
        function sortGames() {
            const sortBy = document.getElementById('sortSelect').value;
            
            games.sort((a, b) => {
                switch(sortBy) {
                    case 'title':
                        return a.title.localeCompare(b.title);
                    
                    case 'date':
                        // Sort by date added (assuming game ID or startDate as proxy)
                        const dateA = a.startDate ? new Date(a.startDate) : new Date(0);
                        const dateB = b.startDate ? new Date(b.startDate) : new Date(0);
                        return dateB - dateA; // Most recent first
                    
                    case 'progress':
                        return (b.progress || 0) - (a.progress || 0); // Highest progress first
                    
                    case 'platform':
                        return a.platform.localeCompare(b.platform);
                    
                    default:
                        return 0;
                }
            });
            
            renderGames();
        }

        // Modal functions
        function openAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add New Game';
            document.getElementById('gameForm').reset();
            document.getElementById('gameId').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('gameModal').classList.add('active');
        }

        function editGame(id) {
            const game = games.find(g => g.id == id);
            if (!game) return;

            currentEditId = id;
            
            document.getElementById('modalTitle').textContent = 'Edit Game';
            document.getElementById('gameId').value = game.id;
            document.getElementById('gameTitle').value = game.title;
            document.getElementById('gameIcon').value = game.icon || '';
            document.getElementById('gamePlatform').value = game.platform;
            document.getElementById('gameStatus').value = game.status;
            document.getElementById('gameStartDate').value = game.startDate || '';
            document.getElementById('gameHours').value = game.hours || 0;
            document.getElementById('gameProgress').value = game.progress || 0;
            document.getElementById('gameCurrentlyPlaying').checked = game.currentlyPlaying || false;
            document.getElementById('gameQuote').value = game.quote || '';
            document.getElementById('gameNotes').value = game.notes || '';
            document.getElementById('gameTrackerUrlData').value = game.trackerUrl || '';
            document.getElementById('gameTrackerUrl').value = game.trackerUrl || '';
            document.getElementById('gameImageUrlData').value = game.imageUrl || '';
            document.getElementById('gameImageUrl').value = game.imageUrl || '';
            
            console.log('üìù Edit Game Debug:');
            console.log('  Game ID:', game.id);
            console.log('  Tracker URL from DB:', game.trackerUrl);
            console.log('  Image URL from DB:', game.imageUrl);
            
            // Show image preview if URL exists
            if (game.imageUrl && game.imageUrl.trim() !== '') {
                document.getElementById('previewImg').src = game.imageUrl;
                document.getElementById('imagePreview').style.display = 'block';
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }

            document.getElementById('gameModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('gameModal').classList.remove('active');
            currentEditId = null;
        }

        function saveGame(event) {
            event.preventDefault();

            // Read URLs only
            const trackerUrlFromInput = document.getElementById('gameTrackerUrl').value.trim();
            const trackerUrlFromHidden = document.getElementById('gameTrackerUrlData').value.trim();
            const trackerUrl = trackerUrlFromInput || trackerUrlFromHidden || null;
            
            const imageUrlFromInput = document.getElementById('gameImageUrl').value.trim();
            const imageUrlFromHidden = document.getElementById('gameImageUrlData').value.trim();
            const imageUrl = imageUrlFromInput || imageUrlFromHidden || null;

            console.log('üìù Save Game Debug:');
            console.log('  Tracker URL (input):', trackerUrlFromInput);
            console.log('  Tracker URL (hidden):', trackerUrlFromHidden);
            console.log('  Tracker URL (final):', trackerUrl);
            console.log('  Image URL (input):', imageUrlFromInput);
            console.log('  Image URL (hidden):', imageUrlFromHidden);
            console.log('  Image URL (final):', imageUrl);

            const gameData = {
                id: currentEditId || Date.now(),
                title: document.getElementById('gameTitle').value,
                icon: document.getElementById('gameIcon').value || 'üéÆ',
                imageUrl: imageUrl,
                platform: document.getElementById('gamePlatform').value,
                status: document.getElementById('gameStatus').value,
                startDate: document.getElementById('gameStartDate').value,
                hours: parseInt(document.getElementById('gameHours').value) || 0,
                progress: parseInt(document.getElementById('gameProgress').value) || 0,
                currentlyPlaying: document.getElementById('gameCurrentlyPlaying').checked,
                quote: document.getElementById('gameQuote').value,
                notes: document.getElementById('gameNotes').value,
                trackerUrl: trackerUrl,
                trackerProgress: currentEditId ? (games.find(g => g.id == currentEditId)?.trackerProgress || {}) : {}
            };

            console.log('üíæ Final game object:', gameData);

            console.log('Saving game:', gameData.title, 'Has tracker URL:', !!gameData.trackerUrl, 'Has image URL:', !!gameData.imageUrl);

            // If setting as currently playing, unset others
            if (gameData.currentlyPlaying) {
                games.forEach(g => g.currentlyPlaying = false);
            }

            if (currentEditId) {
                const index = games.findIndex(g => g.id == currentEditId);
                games[index] = gameData;
            } else {
                games.push(gameData);
            }

            saveGames();
            
            // Save to Firebase if enabled
            if (firebaseInitialized) {
                saveGameToFirebase(gameData);
            } else if (cloudSyncEnabled) {
                // Fallback to CSV cloud sync
                saveGameToCloud(gameData);
            }
            
            updateUI();
            closeModal();
            
            // Clear temporary data after saving
            currentTrackerData = null;
            currentImageData = null;
        }

        function deleteGame(id) {
            if (!confirm('Are you sure you want to delete this game?')) return;

            games = games.filter(g => g.id != id);
            saveGames();
            updateUI();
            
            // Delete from Firebase if enabled
            if (firebaseInitialized) {
                deleteGameFromFirebase(id);
            } else if (cloudSyncEnabled) {
                // Fallback to CSV cloud sync
                deleteGameFromCloud(id);
            }
        }

        function viewGameDetails(id) {
            const game = games.find(g => g.id == id);
            if (!game) return;

            alert(`${game.icon} ${game.title}\n\n` +
                  `Platform: ${game.platform}\n` +
                  `Status: ${getStatusLabel(game.status)}\n` +
                  `Hours: ${game.hours}\n` +
                  `Progress: ${game.progress}%\n\n` +
                  `${game.quote ? 'Quote: ' + game.quote + '\n\n' : ''}` +
                  `${game.notes ? 'Notes: ' + game.notes : ''}`);
        }

        // Export data
        function exportData() {
            // Show export options
            const format = prompt('Export format:\n1. JSON (backup)\n2. CSV (for Google Sheets)\n\nEnter 1 or 2:', '2');
            
            if (format === '1') {
                exportJSON();
            } else if (format === '2') {
                exportCSV();
            }
        }
        
        function exportJSON() {
            const dataStr = JSON.stringify(games, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'game-library-export.json';
            link.click();
        }
        
        function exportCSV() {
            // Create CSV header
            const headers = ['id', 'title', 'icon', 'imageData', 'platform', 'status', 'startDate', 'hours', 'progress', 'currentlyPlaying', 'quote', 'notes', 'trackerHtml'];
            let csv = headers.join(',') + '\n';
            
            // Add game data
            games.forEach(game => {
                const row = headers.map(header => {
                    let value = game[header] || '';
                    // Convert boolean to string
                    if (header === 'currentlyPlaying') {
                        value = game[header] ? 'TRUE' : 'FALSE';
                    }
                    // Escape quotes and wrap in quotes if contains comma or newline
                    if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csv += row.join(',') + '\n';
            });
            
            // Download CSV
            const dataBlob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'game-library-export.csv';
            link.click();
            
            // Show instructions
            setTimeout(() => {
                alert('CSV downloaded!\n\nTo update Google Sheets:\n1. Open your Google Sheet\n2. Select all cells (Ctrl+A)\n3. Delete old data\n4. File ‚Üí Import ‚Üí Upload ‚Üí game-library-export.csv\n5. Replace data\n6. Done! Your published CSV will update automatically.');
            }, 500);
        }

        // Helper functions
        function getStatusLabel(status) {
            const labels = {
                'backlog': 'üìö Backlog',
                'playing': 'üéÆ Playing',
                'completed': '‚úÖ Completed',
                'on-hold': '‚è∏Ô∏è On Hold'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Not set';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
        }

        // Close modal on outside click
        document.getElementById('gameModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('trackerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTrackerModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeTrackerModal();
            }
            if (e.key === 'n' && e.ctrlKey) {
                e.preventDefault();
                openAddModal();
            }
        });
    </script>
</body>
</html>
