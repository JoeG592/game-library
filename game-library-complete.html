<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Library - Track Your Gaming Journey</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --surface: #ffffff;
            --background: #f3f4f6;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .logo-icon {
            font-size: 2rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Grid */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 1rem;
            padding: 3rem;
            margin-bottom: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            align-items: center;
            background-size: cover;
            background-position: center;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(30,41,59,0.9) 0%, rgba(51,65,85,0.85) 50%, rgba(102,126,234,0.1) 100%);
            z-index: 1;
        }

        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 700px;
        }

        .hero-badge {
            display: inline-block;
            background: rgba(102,126,234,0.2);
            color: #a5b4fc;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.75rem;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 1.5rem;
        }

        .hero-meta {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .hero-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .hero-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .hero-empty {
            text-align: center;
            padding: 2rem;
        }

        .hero-empty-icon {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        /* Toolbar */
        .toolbar {
            background: var(--surface);
            padding: 1.25rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: var(--shadow);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.625rem 1rem;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Games Grid */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .game-card {
            background: var(--surface);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            cursor: pointer;
        }

        .game-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .game-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 2rem;
            text-align: center;
            color: white;
            position: relative;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
        }

        .game-header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(102,126,234,0.85), rgba(118,75,162,0.85));
            z-index: 1;
        }

        .game-header > * {
            position: relative;
            z-index: 2;
        }

        .game-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .game-status-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
        }

        .game-body {
            padding: 1.5rem;
        }

        .game-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .game-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .game-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-section {
            margin-bottom: 1rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #34d399);
            border-radius: 1rem;
            transition: width 0.3s;
        }

        .game-actions {
            display: flex;
            gap: 0.75rem;
        }

        .game-btn {
            flex: 1;
            padding: 0.625rem;
            border: 1px solid var(--border);
            background: var(--surface);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .game-btn:hover {
            background: var(--background);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 1rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--background);
            color: var(--text);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-icon {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .empty-text {
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .hero {
                padding: 2rem;
            }

            .hero-title {
                font-size: 2rem;
            }

            .games-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .tracker-modal-content {
                width: 95%;
                height: 95%;
            }
        }

        /* Tracker Preview Modal */
        .tracker-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            padding: 2rem;
        }

        .tracker-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tracker-modal-content {
            background: var(--surface);
            border-radius: 1rem;
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        .tracker-modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 1rem 1rem 0 0;
        }

        .tracker-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .tracker-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .tracker-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .tracker-modal-body {
            flex: 1;
            padding: 0;
            overflow: hidden;
            position: relative;
        }

        .tracker-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .tracker-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--success);
        }

        .game-actions-extended {
            display: flex;
            gap: 0.5rem;
        }

        .game-actions-extended .game-btn {
            flex: 1;
            min-width: 0;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üéÆ</span>
                <span>Game Library</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openCloudSettings()" title="Cloud Sync Settings" id="cloudSyncBtn">
                    ‚òÅÔ∏è Cloud Sync
                </button>
                <button class="btn btn-primary" onclick="openAddModal()">
                    ‚ûï Add Game
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    üíæ Export Data
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Statistics -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalGames">0</div>
                <div class="stat-label">Total Games</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedGames">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="inProgressGames">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalHours">0</div>
                <div class="stat-label">Total Hours</div>
            </div>
        </div>

        <!-- Currently Playing Hero -->
        <div class="hero" id="heroSection">
            <!-- Dynamic content -->
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" placeholder="Search games..." id="searchInput" oninput="filterGames()">
            </div>
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
                <button class="filter-btn" data-filter="playing" onclick="setFilter('playing')">Playing</button>
                <button class="filter-btn" data-filter="completed" onclick="setFilter('completed')">Completed</button>
                <button class="filter-btn" data-filter="backlog" onclick="setFilter('backlog')">Backlog</button>
            </div>
        </div>

        <!-- Games Grid -->
        <div class="games-grid" id="gamesGrid">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- Add/Edit Game Modal -->
    <div class="modal" id="gameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New Game</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="gameForm" onsubmit="saveGame(event)">
                    <div class="form-group">
                        <label class="form-label">Game Title *</label>
                        <input type="text" class="form-input" id="gameTitle" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Icon (Emoji)</label>
                            <input type="text" class="form-input" id="gameIcon" placeholder="üéÆ" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cover Image (optional)</label>
                            <input type="file" class="form-input" id="gameImage" accept="image/*" onchange="handleImageUpload(event)">
                        </div>
                    </div>
                    
                    <div id="imagePreview" style="display: none; margin-bottom: 1.5rem;">
                        <img id="previewImg" style="max-width: 100%; height: 200px; object-fit: cover; border-radius: 0.5rem;">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Platform</label>
                            <select class="form-select" id="gamePlatform">
                                <option value="PC">PC</option>
                                <option value="PlayStation">PlayStation</option>
                                <option value="Xbox">Xbox</option>
                                <option value="Nintendo Switch">Nintendo Switch</option>
                                <option value="Mobile">Mobile</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-select" id="gameStatus" required>
                                <option value="backlog">Backlog</option>
                                <option value="playing">Playing</option>
                                <option value="completed">Completed</option>
                                <option value="on-hold">On Hold</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="gameStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="gameCurrentlyPlaying" style="margin-right: 0.5rem;">
                                Set as Currently Playing
                            </label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Hours Played</label>
                            <input type="number" class="form-input" id="gameHours" min="0" value="0">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Will auto-update from tracker if available</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Progress %</label>
                            <input type="number" class="form-input" id="gameProgress" min="0" max="100" value="0">
                            <small style="color: var(--text-light); font-size: 0.75rem;">Will auto-update from tracker if available</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Favorite Quote</label>
                        <textarea class="form-textarea" id="gameQuote" placeholder="A memorable quote from the game..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="gameNotes" placeholder="Your thoughts, tips, or reminders..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">HTML Tracker</label>
                        <input type="file" class="form-input" id="gameTracker" accept=".html,.htm" onchange="handleTrackerUpload(event)">
                        <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                            Upload an HTML file to track detailed game progress
                        </small>
                        <div id="trackerPreview" style="margin-top: 1rem; display: none;">
                            <div style="background: var(--background); padding: 1rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; gap: 0.75rem;">
                                <span id="trackerFileName" style="font-size: 0.875rem; flex: 1;"></span>
                                <button type="button" class="btn btn-primary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;" onclick="previewCurrentTracker()">üëÅÔ∏è Preview</button>
                                <button type="button" class="btn btn-danger" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;" onclick="removeTracker()">Remove</button>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="gameId">
                    <input type="hidden" id="gameTrackerData">
                    <input type="hidden" id="gameImageData">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" form="gameForm" class="btn btn-success">Save Game</button>
            </div>
        </div>
    </div>

    <!-- Cloud Settings Modal -->
    <div class="modal" id="cloudModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">‚òÅÔ∏è Cloud Sync Settings</h2>
                <button class="modal-close" onclick="closeCloudModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Google Sheets URL</label>
                    <input type="text" class="form-input" id="cloudApiUrl" placeholder="Paste CSV URL or Apps Script URL">
                    <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                        <strong>Option 1 (CSV - Read Only):</strong> File ‚Üí Publish to web ‚Üí CSV<br>
                        <strong>Option 2 (Apps Script - Full Sync):</strong> Use deployed Apps Script URL
                    </small>
                </div>
                
                <div id="cloudStatus" style="margin-top: 1rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--background); border-radius: 0.5rem; font-size: 0.875rem;">
                    <strong>Two Methods Available:</strong>
                    <div style="margin-top: 0.75rem;">
                        <strong style="color: var(--primary);">üìÑ CSV Method (Simple):</strong>
                        <ul style="margin: 0.25rem 0 0 1.25rem; line-height: 1.6; font-size: 0.8125rem;">
                            <li>Read-only (edit sheet to update)</li>
                            <li>No CORS issues</li>
                            <li>Works instantly</li>
                        </ul>
                    </div>
                    <div style="margin-top: 0.75rem;">
                        <strong style="color: var(--success);">üîÑ Apps Script (Advanced):</strong>
                        <ul style="margin: 0.25rem 0 0 1.25rem; line-height: 1.6; font-size: 0.8125rem;">
                            <li>Full two-way sync</li>
                            <li>Edit from Game Library</li>
                            <li>Requires Apps Script setup</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeCloudModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveCloudSettings()">üíæ Save & Load Data</button>
            </div>
        </div>
    </div>

    <!-- Tracker Preview Modal -->
    <div class="tracker-modal" id="trackerModal">
        <div class="tracker-modal-content">
            <div class="tracker-modal-header">
                <h2 class="tracker-modal-title" id="trackerModalTitle">Game Tracker</h2>
                <button class="tracker-modal-close" onclick="closeTrackerModal()">√ó</button>
            </div>
            <div class="tracker-modal-body">
                <iframe id="trackerIframe" class="tracker-iframe"></iframe>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // FIREBASE CONFIGURATION
        // ========================================================================
        
        // PASTE YOUR FIREBASE CONFIG HERE
        // Get this from: Firebase Console ‚Üí Project Settings ‚Üí Your apps ‚Üí Web app
        const firebaseConfig = {
		apiKey: "AIzaSyCYR1pKLa99k6ADLk5QSYJ4XFlzyiF-8G0",
		authDomain: "game-library-741fb.firebaseapp.com",
		databaseURL: "https://game-library-741fb-default-rtdb.firebaseio.com",
		projectId: "game-library-741fb",
		storageBucket: "game-library-741fb.firebasestorage.app",
		messagingSenderId: "766308043698",
		appId: "1:766308043698:web:8a57160441534dd9fdf2ab"
		};
        
        // Initialize Firebase
        let firebaseInitialized = false;
        let database = null;
        
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseInitialized = true;
                console.log('‚úÖ Firebase initialized successfully');
            } else {
                console.log('‚ö†Ô∏è Firebase not configured. Using localStorage only.');
            }
        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error);
            console.log('Falling back to localStorage only');
        }
        
        // ========================================================================
        // DATA STORAGE
        // ========================================================================
        
        // Data storage
        let games = [];
        let currentFilter = 'all';
        let currentEditId = null;
        let currentTrackerData = null;
        let currentImageData = null;
        let cloudApiUrl = localStorage.getItem('cloudApiUrl') || '';
        let cloudSyncEnabled = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Firebase is configured
            if (firebaseInitialized) {
                console.log('üî• Firebase enabled - using real-time sync');
                initializeFirebase();
            } else {
                // Fallback to localStorage
                console.log('üíæ Using localStorage mode');
                loadGames();
                updateUI();
                
                // Check for CSV cloud sync
                if (cloudApiUrl) {
                    cloudSyncEnabled = true;
                    loadFromCloud();
                }
            }
            
            // Listen for messages from tracker iframe
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'TRACKER_SYNC') {
                    console.log('Received tracker sync:', event.data);
                    handleTrackerSync(event.data);
                }
                
                if (event.data && event.data.type === 'TRACKER_PROGRESS_UPDATE') {
                    console.log('Received tracker progress update:', event.data);
                    handleTrackerProgressUpdate(event.data);
                }
            });
        });

        // Handle tracker progress updates (checkboxes)
        function handleTrackerProgressUpdate(data) {
            const gameId = data.gameId;
            const game = games.find(g => g.id == gameId);
            
            if (!game) {
                console.error('Game not found:', gameId);
                return;
            }

            // Update tracker progress
            if (!game.trackerProgress) {
                game.trackerProgress = {};
            }
            
            game.trackerProgress = data.allProgress;
            
            // Save locally
            saveGames();
            
            // Save to Firebase if enabled
            if (firebaseInitialized) {
                saveGameToFirebase(game);
                console.log('‚úÖ Tracker progress synced to Firebase');
            }
        }

        // Firebase initialization and real-time sync
        function initializeFirebase() {
            const gamesRef = database.ref('game-library/games');
            
            // Listen for real-time updates
            gamesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    games = Object.keys(data).map(key => {
                        const game = data[key];
                        return {
                            id: game.id || key,
                            title: game.title,
                            icon: game.icon || 'üéÆ',
                            imageData: game.imageData || null,
                            platform: game.platform,
                            status: game.status,
                            startDate: game.startDate,
                            hours: parseInt(game.hours) || 0,
                            progress: parseInt(game.progress) || 0,
                            currentlyPlaying: game.currentlyPlaying === true || game.currentlyPlaying === 'true',
                            quote: game.quote,
                            notes: game.notes,
                            trackerHtml: game.trackerHtml || null,
                            trackerProgress: game.trackerProgress || {}
                        };
                    });
                } else {
                    games = [];
                }
                
                saveGames(); // Backup to localStorage
                updateUI();
                console.log('üìä Synced from Firebase:', games.length, 'games');
            });
            
            // Handle connection state
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    console.log('üü¢ Connected to Firebase');
                } else {
                    console.log('üî¥ Disconnected from Firebase');
                }
            });
        }

        // Save game to Firebase
        async function saveGameToFirebase(game) {
            if (!firebaseInitialized) return;
            
            try {
                await database.ref('game-library/games/' + game.id).set(game);
                console.log('‚úÖ Game saved to Firebase:', game.title);
            } catch (error) {
                console.error('‚ùå Failed to save to Firebase:', error);
            }
        }

        // Delete game from Firebase
        async function deleteGameFromFirebase(gameId) {
            if (!firebaseInitialized) return;
            
            try {
                await database.ref('game-library/games/' + gameId).remove();
                console.log('‚úÖ Game deleted from Firebase:', gameId);
            } catch (error) {
                console.error('‚ùå Failed to delete from Firebase:', error);
            }
        }

        // Update cloud sync button to show status
        function updateCloudSyncButton() {
            const btn = document.getElementById('cloudSyncBtn');
            if (!btn) return;
            
            if (firebaseInitialized) {
                btn.innerHTML = 'üî• Firebase';
                btn.style.background = 'linear-gradient(135deg, #FF6B6B, #4ECDC4)';
                btn.style.color = 'white';
                btn.title = 'Firebase Real-Time Sync Active';
            } else if (cloudSyncEnabled) {
                btn.innerHTML = '‚òÅÔ∏è CSV Sync';
                btn.title = 'CSV Cloud Sync Active';
            } else {
                btn.innerHTML = '‚òÅÔ∏è Cloud Sync';
                btn.title = 'Configure Cloud Sync';
            }
        }

        // Cloud sync functions
        function openCloudSettings() {
            document.getElementById('cloudApiUrl').value = cloudApiUrl;
            document.getElementById('cloudModal').classList.add('active');
        }

        function closeCloudModal() {
            document.getElementById('cloudModal').classList.remove('active');
        }

        function saveCloudSettings() {
            const url = document.getElementById('cloudApiUrl').value.trim();
            
            if (!url) {
                showCloudStatus('Please enter an API URL', 'error');
                return;
            }
            
            cloudApiUrl = url;
            localStorage.setItem('cloudApiUrl', url);
            cloudSyncEnabled = true;
            
            showCloudStatus('Settings saved! Testing connection...', 'info');
            
            // Test connection
            testCloudConnection();
        }

        function testCloudConnection() {
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            
            if (isCsvUrl) {
                // CSV test
                showCloudStatus('Testing CSV connection...', 'info');
                
                fetch(cloudApiUrl)
                    .then(response => response.text())
                    .then(csvText => {
                        const lines = csvText.split('\n').filter(line => line.trim());
                        if (lines.length >= 1) {
                            const dataRows = lines.length - 1;
                            showCloudStatus(`‚úì Connected! Found ${dataRows} games in cloud. (Read-Only CSV Method)`, 'success');
                            setTimeout(() => {
                                loadFromCloud();
                            }, 2000);
                        } else {
                            showCloudStatus('Connected but no data found.', 'error');
                        }
                    })
                    .catch(error => {
                        showCloudStatus('Connection failed: ' + error.message, 'error');
                    });
            } else {
                // Apps Script JSONP test
                showCloudStatus('Testing Apps Script connection...', 'info');
                
                const callbackName = 'testCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success) {
                        showCloudStatus(`‚úì Connected! Found ${data.games?.length || 0} games. (Full Sync Enabled)`, 'success');
                        setTimeout(() => {
                            loadFromCloud();
                        }, 2000);
                    } else {
                        showCloudStatus('Connection failed: ' + (data.error || 'Unknown error'), 'error');
                    }
                };
                
                const url = cloudApiUrl + (cloudApiUrl.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    showCloudStatus('Connection failed. Make sure the Apps Script is deployed correctly.', 'error');
                };
                
                document.body.appendChild(script);
            }
        }

        function showCloudStatus(message, type) {
            const status = document.getElementById('cloudStatus');
            status.style.display = 'block';
            status.textContent = message;
            
            if (type === 'success') {
                status.style.background = 'var(--success)';
                status.style.color = 'white';
            } else if (type === 'error') {
                status.style.background = 'var(--danger)';
                status.style.color = 'white';
            } else {
                status.style.background = 'var(--warning)';
                status.style.color = 'white';
            }
        }

        async function loadFromCloud() {
            if (!cloudApiUrl) return;
            
            // Check if this is a CSV URL or Apps Script URL
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            
            if (isCsvUrl) {
                // CSV method
                return loadFromCloudCSV();
            } else {
                // Apps Script JSONP method
                return loadFromCloudJSONP();
            }
        }
        
        async function loadFromCloudCSV() {
            try {
                console.log('Loading from cloud (CSV):', cloudApiUrl);
                const response = await fetch(cloudApiUrl);
                const csvText = await response.text();
                
                console.log('Received CSV data, parsing...');
                
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    console.log('No data in CSV');
                    return;
                }
                
                const headers = parseCSVLine(lines[0]);
                console.log('Headers:', headers);
                
                const parsedGames = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values[0]) {
                        const game = {};
                        headers.forEach((header, index) => {
                            game[header] = values[index] || '';
                        });
                        parsedGames.push(game);
                    }
                }
                
                console.log('Parsed', parsedGames.length, 'games from CSV');
                
                games = parsedGames.map(game => ({
                    id: game.id,
                    title: game.title,
                    icon: game.icon || 'üéÆ',
                    imageData: game.imageData || null,
                    platform: game.platform,
                    status: game.status,
                    startDate: game.startDate,
                    hours: parseInt(game.hours) || 0,
                    progress: parseInt(game.progress) || 0,
                    currentlyPlaying: game.currentlyPlaying === 'TRUE' || game.currentlyPlaying === 'true',
                    quote: game.quote,
                    notes: game.notes,
                    trackerHtml: game.trackerHtml || null
                }));
                
                saveGames();
                updateUI();
                console.log('Successfully loaded', games.length, 'games from cloud (CSV)');
                
            } catch (error) {
                console.error('Failed to load from cloud (CSV):', error);
            }
        }
        
        async function loadFromCloudJSONP() {
            return new Promise((resolve, reject) => {
                console.log('Loading from cloud (JSONP):', cloudApiUrl);
                
                const callbackName = 'gameLibraryCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success && data.games) {
                        games = data.games.map(game => ({
                            id: game.id,
                            title: game.title,
                            icon: game.icon || 'üéÆ',
                            imageData: game.imageData || null,
                            platform: game.platform,
                            status: game.status,
                            startDate: game.startDate,
                            hours: parseInt(game.hours) || 0,
                            progress: parseInt(game.progress) || 0,
                            currentlyPlaying: game.currentlyPlaying === 'TRUE' || game.currentlyPlaying === true,
                            quote: game.quote,
                            notes: game.notes,
                            trackerHtml: game.trackerHtml || null
                        }));
                        
                        saveGames();
                        updateUI();
                        console.log('Successfully loaded', games.length, 'games from cloud (JSONP)');
                        resolve();
                    } else {
                        reject(new Error('Invalid response'));
                    }
                };
                
                const url = cloudApiUrl + (cloudApiUrl.includes('?') ? '&' : '?') + 'callback=' + callbackName;
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Failed to load script'));
                };
                
                document.body.appendChild(script);
            });
        }
        
        // Helper function to parse CSV line (handles quotes)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result;
        }

        async function syncToCloud() {
            if (!cloudApiUrl) {
                alert('Please configure Cloud Sync settings first');
                openCloudSettings();
                return;
            }
            
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            
            if (isCsvUrl) {
                alert('Cloud sync is read-only when using CSV publishing.\n\nTo update your game library:\n1. Edit the Google Sheet directly\n2. Changes appear automatically in Game Library\n3. Refresh this page to see updates');
                return;
            }
            
            // Apps Script method with JSONP
            showCloudStatus('Syncing ' + games.length + ' games to cloud...', 'info');
            
            return new Promise((resolve, reject) => {
                const callbackName = 'syncCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success) {
                        showCloudStatus('‚úì Successfully synced to cloud!', 'success');
                        
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-lg); z-index: 10000;';
                        notification.innerHTML = '‚òÅÔ∏è Synced ' + games.length + ' games to cloud!';
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 3000);
                        resolve();
                    } else {
                        showCloudStatus('Sync failed: ' + (data.error || 'Unknown error'), 'error');
                        reject(new Error(data.error));
                    }
                };
                
                const payload = encodeURIComponent(JSON.stringify({
                    action: 'sync_all',
                    games: games,
                    callback: callbackName
                }));
                
                // For JSONP POST simulation, we need to use GET with data in URL
                // This is a limitation - large data might hit URL length limits
                const url = cloudApiUrl + '?callback=' + callbackName + '&data=' + payload;
                
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    showCloudStatus('Sync failed: Network error', 'error');
                    reject(new Error('Network error'));
                };
                
                document.body.appendChild(script);
            });
        }

        async function saveGameToCloud(game) {
            if (!cloudSyncEnabled || !cloudApiUrl) return;
            
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            if (isCsvUrl) {
                console.log('Note: CSV is read-only - edit the Google Sheet directly');
                return;
            }
            
            // JSONP method for single game save
            return new Promise((resolve, reject) => {
                const callbackName = 'saveCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success) {
                        console.log('Game synced to cloud:', game.title);
                        resolve();
                    } else {
                        console.error('Failed to sync game:', data.error);
                        reject(new Error(data.error));
                    }
                };
                
                const payload = encodeURIComponent(JSON.stringify({
                    action: 'save',
                    game: game,
                    callback: callbackName
                }));
                
                const url = cloudApiUrl + '?callback=' + callbackName + '&data=' + payload;
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Network error'));
                };
                
                document.body.appendChild(script);
            });
        }

        async function deleteGameFromCloud(gameId) {
            if (!cloudSyncEnabled || !cloudApiUrl) return;
            
            const isCsvUrl = cloudApiUrl.includes('/pub?') || cloudApiUrl.includes('output=csv');
            if (isCsvUrl) {
                console.log('Note: CSV is read-only - edit the Google Sheet directly');
                return;
            }
            
            // JSONP method for delete
            return new Promise((resolve, reject) => {
                const callbackName = 'deleteCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    
                    if (data.success) {
                        console.log('Game deleted from cloud:', gameId);
                        resolve();
                    } else {
                        console.error('Failed to delete game:', data.error);
                        reject(new Error(data.error));
                    }
                };
                
                const payload = encodeURIComponent(JSON.stringify({
                    action: 'delete',
                    gameId: gameId,
                    callback: callbackName
                }));
                
                const url = cloudApiUrl + '?callback=' + callbackName + '&data=' + payload;
                script.src = url;
                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Network error'));
                };
                
                document.body.appendChild(script);
            });
        }

        // Handle tracker sync data
        function handleTrackerSync(data) {
            const gameId = data.gameId;
            const game = games.find(g => g.id == gameId);
            
            if (!game) {
                console.error('Game not found:', gameId);
                alert('Error: Could not find game to update');
                return;
            }

            // Update game data
            const oldHours = game.hours;
            const oldProgress = game.progress;
            
            if (data.hours !== undefined) {
                game.hours = parseInt(data.hours);
            }
            if (data.progress !== undefined) {
                game.progress = parseInt(data.progress);
            }

            // Save and update UI
            saveGames();
            updateUI();
            
            // Sync to Firebase or cloud if enabled
            if (firebaseInitialized) {
                saveGameToFirebase(game);
            } else if (cloudSyncEnabled) {
                saveGameToCloud(game);
            }

            // Show success notification
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-lg); z-index: 10000; animation: slideInRight 0.3s;';
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 0.25rem;">‚úì Synced from Tracker${firebaseInitialized ? ' to Firebase' : cloudSyncEnabled ? ' & Cloud' : ''}</div>
                <div style="font-size: 0.875rem;">
                    ${data.hours !== undefined ? `Hours: ${oldHours} ‚Üí ${game.hours}` : ''}
                    ${data.hours !== undefined && data.progress !== undefined ? '<br>' : ''}
                    ${data.progress !== undefined ? `Progress: ${oldProgress}% ‚Üí ${game.progress}%` : ''}
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);

            console.log('Game updated:', game);
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                document.getElementById('gameImageData').value = currentImageData;
                document.getElementById('previewImg').src = currentImageData;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Handle tracker file upload
        function handleTrackerUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentTrackerData = e.target.result;
                document.getElementById('gameTrackerData').value = currentTrackerData;
                document.getElementById('trackerFileName').textContent = file.name;
                document.getElementById('trackerPreview').style.display = 'block';
                
                // Extract hours and progress from tracker
                extractTrackerData(currentTrackerData);
            };
            reader.readAsText(file);
        }

        // Extract hours and progress from tracker HTML
        function extractTrackerData(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const bodyText = doc.body.textContent;
                
                console.log('=== TRACKER EXTRACTION DEBUG ===');
                console.log('First 500 chars of tracker:', bodyText.substring(0, 500));
                
                // Look for hours played - expanded patterns
                let hours = null;
                
                // Pattern 1: "12H 56M" or "12h 56m" format (with or without space)
                const timeFormatMatch = bodyText.match(/(\d+)\s*H\s*(\d+)\s*M/i);
                if (timeFormatMatch) {
                    const h = parseInt(timeFormatMatch[1]);
                    const m = parseInt(timeFormatMatch[2]);
                    hours = h + Math.round(m / 60); // Round minutes to nearest hour
                    console.log('‚úì Extracted time from H/M format:', timeFormatMatch[0], '‚Üí', hours, 'hours');
                }
                
                // Pattern 2: Just hours like "12H"
                if (hours === null) {
                    const simpleHoursMatch = bodyText.match(/(\d+)\s*H(?!\s*\d)/i);
                    if (simpleHoursMatch) {
                        hours = parseInt(simpleHoursMatch[1]);
                        console.log('‚úì Extracted hours from H format:', simpleHoursMatch[0], '‚Üí', hours);
                    }
                }
                
                // Pattern 3: Standard text formats
                if (hours === null) {
                    const hoursPatterns = [
                        /time\s*watched[:\s]*(\d+)/i,
                        /(\d+)\s*hours?\s*played/i,
                        /hours?\s*played[:\s]*(\d+)/i,
                        /total\s*hours?[:\s]*(\d+)/i,
                        /playtime[:\s]*(\d+)/i
                    ];
                    
                    for (let pattern of hoursPatterns) {
                        const match = bodyText.match(pattern);
                        if (match) {
                            hours = parseInt(match[1]);
                            console.log('‚úì Extracted hours from pattern:', match[0]);
                            break;
                        }
                    }
                }
                
                // Look for progress percentage
                let progress = null;
                const progressPatterns = [
                    /completion[:\s]*(\d+)\s*%/i,
                    /(\d+)\s*%\s*complete/i,
                    /progress[:\s]*(\d+)\s*%/i,
                    /(\d+)\s*%\s*progress/i,
                    /time\s*progress[:\s]*(\d+)\s*%/i,
                    // More specific pattern for your tracker
                    /COMPLETION[:\s\n]*(\d+)\s*%/i
                ];
                
                for (let pattern of progressPatterns) {
                    const match = bodyText.match(pattern);
                    if (match) {
                        progress = parseInt(match[1]);
                        console.log('‚úì Extracted progress from pattern:', match[0].substring(0, 50));
                        break;
                    }
                }
                
                console.log('Final results - Hours:', hours, 'Progress:', progress);
                console.log('=================================');
                
                // Update form fields if found
                if (hours !== null) {
                    document.getElementById('gameHours').value = hours;
                }
                if (progress !== null) {
                    document.getElementById('gameProgress').value = progress;
                }
                
                if (hours !== null || progress !== null) {
                    // Show notification
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-lg); z-index: 9999;';
                    notification.innerHTML = `‚úì Auto-filled from tracker:<br>${hours !== null ? hours + ' hours' : 'No hours found'}${hours !== null && progress !== null ? ' ‚Ä¢ ' : ''}${progress !== null ? progress + '% progress' : progress === null && hours !== null ? ' ‚Ä¢ No progress found' : 'No progress found'}`;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 5000);
                } else {
                    // Show warning if nothing found
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--warning); color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-lg); z-index: 9999;';
                    notification.innerHTML = `‚ö†Ô∏è Could not auto-extract data from tracker<br><small>Please enter hours and progress manually</small>`;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 5000);
                    console.warn('No hours or progress found. Check console for tracker text preview.');
                }
            } catch (error) {
                console.error('Error extracting tracker data:', error);
            }
        }

        // Remove tracker
        function removeTracker() {
            currentTrackerData = null;
            document.getElementById('gameTracker').value = '';
            document.getElementById('gameTrackerData').value = '';
            document.getElementById('trackerPreview').style.display = 'none';
        }

        // Preview current tracker (before saving)
        function previewCurrentTracker() {
            if (!currentTrackerData) {
                alert('No tracker data available to preview.');
                return;
            }

            const gameTitle = document.getElementById('gameTitle').value || 'Game';
            const gameIcon = document.getElementById('gameIcon').value || 'üéÆ';
            
            document.getElementById('trackerModalTitle').textContent = `${gameIcon} ${gameTitle} - Tracker Preview`;
            const iframe = document.getElementById('trackerIframe');
            iframe.srcdoc = currentTrackerData;
            document.getElementById('trackerModal').classList.add('active');
        }

        // Open tracker in modal
        function openTracker(id) {
            const game = games.find(g => g.id == id);
            if (!game || !game.trackerHtml) {
                alert('No tracker uploaded for this game.');
                return;
            }

            document.getElementById('trackerModalTitle').textContent = `${game.icon} ${game.title} - Tracker`;
            const iframe = document.getElementById('trackerIframe');
            
            // Inject game ID into tracker HTML so it knows which game to sync
            let trackerHtml = game.trackerHtml;
            
            // Add Firebase-aware checkbox sync script
            const syncScript = `
                <script>
                // Game Library Sync Integration
                window.gameLibraryGameId = '${game.id}';
                window.trackerProgress = ${JSON.stringify(game.trackerProgress || {})};
                window.firebaseEnabled = ${firebaseInitialized};
                
                // Function for tracker to call when it wants to sync data back
                window.syncToGameLibrary = function(hours, progress) {
                    console.log('Syncing to Game Library:', hours, 'hours,', progress, '% progress');
                    
                    window.parent.postMessage({
                        type: 'TRACKER_SYNC',
                        gameId: window.gameLibraryGameId,
                        hours: hours,
                        progress: progress
                    }, '*');
                    
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 99999; font-family: system-ui, sans-serif;';
                    notification.innerHTML = '‚úì Synced to Game Library!';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                };
                
                // Sync checkbox state to Firebase
                window.syncCheckbox = function(checkboxId, checked) {
                    window.trackerProgress[checkboxId] = checked;
                    
                    window.parent.postMessage({
                        type: 'TRACKER_PROGRESS_UPDATE',
                        gameId: window.gameLibraryGameId,
                        checkboxId: checkboxId,
                        checked: checked,
                        allProgress: window.trackerProgress
                    }, '*');
                };
                
                // Auto-setup on page load
                window.addEventListener('DOMContentLoaded', function() {
                    console.log('üî• Tracker initialized with Firebase sync');
                    console.log('üìä Loaded progress:', Object.keys(window.trackerProgress).length, 'items');
                    
                    // Find all checkboxes and apply saved state
                    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                    let appliedCount = 0;
                    
                    checkboxes.forEach((checkbox, index) => {
                        // Generate unique ID for checkbox
                        let checkboxId = checkbox.id;
                        if (!checkboxId) {
                            // Create ID from nearby text or index
                            const label = checkbox.nextElementSibling || checkbox.parentElement;
                            const text = label ? label.textContent.trim().substring(0, 50) : '';
                            checkboxId = 'checkbox_' + index + '_' + text.replace(/[^a-zA-Z0-9]/g, '_');
                            checkbox.setAttribute('data-tracker-id', checkboxId);
                        }
                        
                        // Apply saved state
                        if (window.trackerProgress.hasOwnProperty(checkboxId)) {
                            checkbox.checked = window.trackerProgress[checkboxId];
                            appliedCount++;
                        }
                        
                        // Add change listener
                        checkbox.addEventListener('change', function() {
                            const id = this.id || this.getAttribute('data-tracker-id');
                            window.syncCheckbox(id, this.checked);
                            
                            // Calculate completion percentage
                            updateTrackerStats();
                        });
                    });
                    
                    console.log('‚úÖ Applied saved state to', appliedCount, 'checkboxes');
                    
                    // Initial stats calculation
                    updateTrackerStats();
                    
                    // Add Check All buttons
                    addCheckAllButtons();
                    
                    // Check if tracker already has a sync button
                    if (!document.querySelector('[data-sync-button]')) {
                        createSyncButton();
                    }
                });
                
                function addCheckAllButtons() {
                    // Find sections with checkboxes
                    const sections = findCheckboxSections();
                    
                    sections.forEach(section => {
                        if (section.checkboxes.length > 3) { // Only add if section has multiple checkboxes
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'tracker-check-all-buttons';
                            buttonContainer.style.cssText = 'margin: 1rem 0; padding: 1rem; background: rgba(102,126,234,0.05); border: 2px solid rgba(102,126,234,0.2); border-radius: 0.75rem; display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;';
                            
                            // Section label
                            const label = document.createElement('span');
                            label.textContent = section.name + ':';
                            label.style.cssText = 'font-weight: 700; color: #667eea; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;';
                            
                            // Check All button
                            const checkAllBtn = document.createElement('button');
                            checkAllBtn.textContent = '‚úì Check All';
                            checkAllBtn.style.cssText = 'padding: 0.625rem 1.25rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16,185,129,0.3);';
                            checkAllBtn.onmouseover = function() { 
                                this.style.background = '#059669'; 
                                this.style.transform = 'translateY(-2px)';
                                this.style.boxShadow = '0 6px 16px rgba(16,185,129,0.4)';
                            };
                            checkAllBtn.onmouseout = function() { 
                                this.style.background = '#10b981'; 
                                this.style.transform = 'translateY(0)';
                                this.style.boxShadow = '0 4px 12px rgba(16,185,129,0.3)';
                            };
                            checkAllBtn.onclick = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                section.checkboxes.forEach(cb => {
                                    if (!cb.checked) {
                                        cb.checked = true;
                                        cb.dispatchEvent(new Event('change', { bubbles: true }));
                                    }
                                });
                            };
                            
                            // Uncheck All button
                            const uncheckAllBtn = document.createElement('button');
                            uncheckAllBtn.textContent = '‚úó Uncheck All';
                            uncheckAllBtn.style.cssText = 'padding: 0.625rem 1.25rem; background: #ef4444; color: white; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; box-shadow: 0 4px 12px rgba(239,68,68,0.3);';
                            uncheckAllBtn.onmouseover = function() { 
                                this.style.background = '#dc2626'; 
                                this.style.transform = 'translateY(-2px)';
                                this.style.boxShadow = '0 6px 16px rgba(239,68,68,0.4)';
                            };
                            uncheckAllBtn.onmouseout = function() { 
                                this.style.background = '#ef4444'; 
                                this.style.transform = 'translateY(0)';
                                this.style.boxShadow = '0 4px 12px rgba(239,68,68,0.3)';
                            };
                            uncheckAllBtn.onclick = function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                section.checkboxes.forEach(cb => {
                                    if (cb.checked) {
                                        cb.checked = false;
                                        cb.dispatchEvent(new Event('change', { bubbles: true }));
                                    }
                                });
                            };
                            
                            // Progress counter (separate, distinct styling)
                            const counter = document.createElement('span');
                            counter.style.cssText = 'padding: 0.625rem 1.25rem; background: white; color: #667eea; border: 2px solid #667eea; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 700; display: inline-flex; align-items: center; margin-left: auto;';
                            
                            function updateCounter() {
                                const checked = section.checkboxes.filter(cb => cb.checked).length;
                                const total = section.checkboxes.length;
                                const percentage = Math.round((checked / total) * 100);
                                counter.textContent = checked + ' / ' + total + ' (' + percentage + '%)';
                            }
                            updateCounter();
                            
                            // Update counter when checkboxes change
                            section.checkboxes.forEach(cb => {
                                cb.addEventListener('change', updateCounter);
                            });
                            
                            buttonContainer.appendChild(label);
                            buttonContainer.appendChild(checkAllBtn);
                            buttonContainer.appendChild(uncheckAllBtn);
                            buttonContainer.appendChild(counter);
                            
                            // Insert BEFORE the section header (so it's above the section)
                            if (section.header) {
                                section.header.parentElement.insertBefore(buttonContainer, section.header);
                            } else if (section.checkboxes[0].parentElement) {
                                // If no header, insert before first checkbox's parent
                                const parent = section.checkboxes[0].parentElement;
                                parent.parentElement.insertBefore(buttonContainer, parent);
                            }
                        }
                    });
                    
                    // Add master Check All button at top if there are many checkboxes
                    const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
                    if (allCheckboxes.length > 10) {
                        addMasterCheckAllButtons();
                    }
                }
                
                function findCheckboxSections() {
                    const sections = [];
                    
                    // Try to find sections by headers (h1, h2, h3, h4)
                    const headers = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
                    
                    headers.forEach(header => {
                        const checkboxes = [];
                        let next = header.nextElementSibling;
                        
                        // Collect checkboxes until next header or max distance
                        let distance = 0;
                        while (next && !next.matches('h1, h2, h3, h4, h5, h6') && distance < 20) {
                            const cbs = next.querySelectorAll('input[type="checkbox"]');
                            checkboxes.push(...Array.from(cbs));
                            next = next.nextElementSibling;
                            distance++;
                        }
                        
                        if (checkboxes.length > 0) {
                            sections.push({
                                name: header.textContent.trim().substring(0, 50),
                                header: header,
                                checkboxes: checkboxes
                            });
                        }
                    });
                    
                    // Also look for divs/sections with specific classes or IDs that might contain checkboxes
                    const containers = document.querySelectorAll('[class*="section"], [class*="chapter"], [class*="part"], [id*="section"], [id*="chapter"], [id*="part"]');
                    containers.forEach(container => {
                        const checkboxes = Array.from(container.querySelectorAll('input[type="checkbox"]'));
                        if (checkboxes.length > 0) {
                            // Check if we haven't already added these checkboxes
                            const alreadyAdded = sections.some(s => 
                                s.checkboxes.some(cb => checkboxes.includes(cb))
                            );
                            
                            if (!alreadyAdded) {
                                const name = container.getAttribute('id') || 
                                           container.getAttribute('class') || 
                                           container.textContent.trim().substring(0, 50);
                                sections.push({
                                    name: name,
                                    header: container,
                                    checkboxes: checkboxes
                                });
                            }
                        }
                    });
                    
                    // If no sections found, group all checkboxes
                    if (sections.length === 0) {
                        const allCheckboxes = Array.from(document.querySelectorAll('input[type="checkbox"]'));
                        if (allCheckboxes.length > 0) {
                            sections.push({
                                name: 'All Items',
                                header: null,
                                checkboxes: allCheckboxes
                            });
                        }
                    }
                    
                    return sections;
                }
                
                function addMasterCheckAllButtons() {
                    const masterContainer = document.createElement('div');
                    masterContainer.style.cssText = 'position: fixed; top: 70px; left: 20px; background: linear-gradient(135deg, #667eea, #764ba2); padding: 1rem; border-radius: 1rem; box-shadow: 0 10px 30px rgba(102,126,234,0.4); z-index: 99997; display: flex; flex-direction: column; gap: 0.75rem; min-width: 180px;';
                    
                    const title = document.createElement('div');
                    title.textContent = 'QUICK ACTIONS';
                    title.style.cssText = 'font-weight: 800; font-size: 0.75rem; text-transform: uppercase; color: white; letter-spacing: 0.1em; text-align: center;';
                    
                    const checkAllBtn = document.createElement('button');
                    checkAllBtn.textContent = '‚úì Check All';
                    checkAllBtn.style.cssText = 'padding: 0.75rem 1rem; background: white; color: #667eea; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 700; cursor: pointer; font-family: inherit; transition: all 0.2s; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                    checkAllBtn.onmouseover = function() { 
                        this.style.transform = 'scale(1.05)';
                        this.style.boxShadow = '0 6px 16px rgba(0,0,0,0.2)';
                    };
                    checkAllBtn.onmouseout = function() { 
                        this.style.transform = 'scale(1)';
                        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    };
                    checkAllBtn.onclick = function() {
                        const all = document.querySelectorAll('input[type="checkbox"]');
                        all.forEach(cb => {
                            if (!cb.checked) {
                                cb.checked = true;
                                cb.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        });
                    };
                    
                    const uncheckAllBtn = document.createElement('button');
                    uncheckAllBtn.textContent = '‚úó Uncheck All';
                    uncheckAllBtn.style.cssText = 'padding: 0.75rem 1rem; background: white; color: #ef4444; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 700; cursor: pointer; font-family: inherit; transition: all 0.2s; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                    uncheckAllBtn.onmouseover = function() { 
                        this.style.transform = 'scale(1.05)';
                        this.style.boxShadow = '0 6px 16px rgba(0,0,0,0.2)';
                    };
                    uncheckAllBtn.onmouseout = function() { 
                        this.style.transform = 'scale(1)';
                        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    };
                    uncheckAllBtn.onclick = function() {
                        const all = document.querySelectorAll('input[type="checkbox"]');
                        all.forEach(cb => {
                            if (cb.checked) {
                                cb.checked = false;
                                cb.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        });
                    };
                    
                    masterContainer.appendChild(title);
                    masterContainer.appendChild(checkAllBtn);
                    masterContainer.appendChild(uncheckAllBtn);
                    
                    document.body.appendChild(masterContainer);
                }
                
                function updateTrackerStats() {
                    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                    const total = checkboxes.length;
                    const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
                    const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;
                    
                    // Update progress indicator if it exists
                    let indicator = document.getElementById('tracker-progress-indicator');
                    if (!indicator && total > 0) {
                        indicator = document.createElement('div');
                        indicator.id = 'tracker-progress-indicator';
                        indicator.style.cssText = 'position: fixed; top: 20px; left: 20px; background: rgba(102,126,234,0.95); color: white; padding: 0.75rem 1.25rem; border-radius: 0.75rem; font-family: system-ui, sans-serif; font-size: 0.875rem; font-weight: 600; box-shadow: 0 10px 25px rgba(102,126,234,0.3); z-index: 99998;';
                        document.body.appendChild(indicator);
                    }
                    
                    if (indicator) {
                        indicator.textContent = checked + ' / ' + total + ' (' + percentage + '%)';
                    }
                }
                
                function createSyncButton() {
                    const syncButton = document.createElement('button');
                    syncButton.setAttribute('data-sync-button', 'true');
                    syncButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 1rem 1.5rem; border-radius: 0.75rem; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 10px 25px rgba(102,126,234,0.3); z-index: 99999; font-family: system-ui, sans-serif; transition: all 0.2s;';
                    syncButton.innerHTML = 'üîÑ Sync Progress to Library';
                    syncButton.onmouseover = function() {
                        this.style.transform = 'translateY(-2px)';
                        this.style.boxShadow = '0 15px 35px rgba(102,126,234,0.4)';
                    };
                    syncButton.onmouseout = function() {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '0 10px 25px rgba(102,126,234,0.3)';
                    };
                    syncButton.onclick = function() {
                        const bodyText = document.body.textContent;
                        
                        let hours = null;
                        const timeMatch = bodyText.match(/(\\d+)\\s*H\\s*(\\d+)\\s*M/i);
                        if (timeMatch) {
                            hours = parseInt(timeMatch[1]) + Math.round(parseInt(timeMatch[2]) / 60);
                        }
                        
                        // Calculate progress from checkboxes
                        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                        const total = checkboxes.length;
                        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
                        const progress = total > 0 ? Math.round((checked / total) * 100) : null;
                        
                        if (hours !== null || progress !== null) {
                            window.syncToGameLibrary(hours, progress);
                        } else {
                            alert('Could not extract hours or progress from tracker.');
                        }
                    };
                    document.body.appendChild(syncButton);
                }
                <\/script>
            `;
            
            // Inject the script before closing body tag
            if (trackerHtml.includes('</body>')) {
                trackerHtml = trackerHtml.replace('</body>', syncScript + '</body>');
            } else {
                trackerHtml += syncScript;
            }
            
            iframe.srcdoc = trackerHtml;
            document.getElementById('trackerModal').classList.add('active');
        }

        // Close tracker modal
        function closeTrackerModal() {
            document.getElementById('trackerModal').classList.remove('active');
            document.getElementById('trackerIframe').srcdoc = '';
        }

        // Load games from localStorage
        function loadGames() {
            const stored = localStorage.getItem('gameLibrary');
            if (stored) {
                games = JSON.parse(stored);
            } else {
                // Sample data
                games = [
                    {
                        id: Date.now() + 1,
                        title: 'Final Fantasy XVI',
                        icon: '‚öîÔ∏è',
                        platform: 'PlayStation',
                        status: 'playing',
                        startDate: '2025-01-01',
                        hours: 32,
                        progress: 47,
                        currentlyPlaying: true,
                        quote: 'The legacy of the Crystals has shaped our history for long enough.',
                        notes: 'Amazing combat system!'
                    },
                    {
                        id: Date.now() + 2,
                        title: 'Elden Ring',
                        icon: 'üó°Ô∏è',
                        platform: 'PC',
                        status: 'completed',
                        startDate: '2024-12-15',
                        hours: 82,
                        progress: 100,
                        currentlyPlaying: false,
                        quote: 'Rise, Tarnished.',
                        notes: 'Best FromSoftware game yet!'
                    }
                ];
                saveGames();
            }
        }

        // Save games to localStorage
        function saveGames() {
            localStorage.setItem('gameLibrary', JSON.stringify(games));
        }

        // Update entire UI
        function updateUI() {
            updateStats();
            updateHero();
            renderGames();
        }

        // Update statistics
        function updateStats() {
            const total = games.length;
            const completed = games.filter(g => g.status === 'completed').length;
            const inProgress = games.filter(g => g.status === 'playing').length;
            const totalHours = games.reduce((sum, g) => sum + (g.hours || 0), 0);

            document.getElementById('totalGames').textContent = total;
            document.getElementById('completedGames').textContent = completed;
            document.getElementById('inProgressGames').textContent = inProgress;
            document.getElementById('totalHours').textContent = totalHours;
        }

        // Update hero section
        function updateHero() {
            const hero = document.getElementById('heroSection');
            const currentGame = games.find(g => g.currentlyPlaying);

            console.log('Updating hero. Current game:', currentGame?.title, 'Has tracker:', !!currentGame?.trackerHtml);
            
            // Update cloud sync button status
            updateCloudSyncButton();

            if (currentGame) {
                const backgroundStyle = currentGame.imageData 
                    ? `background-image: url('${currentGame.imageData}');` 
                    : '';
                    
                hero.setAttribute('style', backgroundStyle);
                hero.innerHTML = `
                    <div class="hero-content">
                        <div class="hero-badge">üéÆ Currently Playing</div>
                        <h1 class="hero-title">${currentGame.icon} ${currentGame.title}</h1>
                        <p class="hero-subtitle">${currentGame.quote || 'An epic gaming journey awaits!'}</p>
                        <div class="hero-meta">
                            <div class="hero-meta-item">‚è±Ô∏è ${currentGame.hours} hours played</div>
                            <div class="hero-meta-item">üìä ${currentGame.progress}% complete</div>
                            <div class="hero-meta-item">üéØ ${currentGame.platform}</div>
                            ${currentGame.trackerHtml ? '<div class="hero-meta-item">üìÑ Has Tracker</div>' : ''}
                        </div>
                        <div class="hero-actions">
                            ${currentGame.trackerHtml ? `<button class="btn btn-primary" onclick="openTracker('${currentGame.id}')">üìä Open Tracker</button>` : ''}
                            <button class="btn ${currentGame.trackerHtml ? 'btn-secondary' : 'btn-primary'}" onclick="editGame('${currentGame.id}')">Update Progress</button>
                        </div>
                    </div>
                `;
            } else {
                hero.innerHTML = `
                    <div class="hero-empty">
                        <div class="hero-empty-icon">üéÆ</div>
                        <h2>No Game Currently Playing</h2>
                        <p style="opacity: 0.7; margin-bottom: 1.5rem;">Add a game and mark it as "Currently Playing" to see it here</p>
                        <button class="btn btn-primary" onclick="openAddModal()">Add Your First Game</button>
                    </div>
                `;
            }
        }

        // Render games grid
        function renderGames() {
            const grid = document.getElementById('gamesGrid');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = games.filter(game => {
                const matchesSearch = game.title.toLowerCase().includes(searchTerm);
                const matchesFilter = currentFilter === 'all' || game.status === currentFilter;
                return matchesSearch && matchesFilter;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">üéØ</div>
                        <h3 class="empty-title">No Games Found</h3>
                        <p class="empty-text">Try adjusting your search or filters</p>
                        <button class="btn btn-primary" onclick="openAddModal()">Add New Game</button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(game => {
                const headerStyle = game.imageData 
                    ? `background-image: url('${game.imageData}');` 
                    : '';
                    
                return `
                <div class="game-card" onclick="viewGameDetails('${game.id}')">
                    <div class="game-header" style="${headerStyle}">
                        <div class="game-status-badge">${getStatusLabel(game.status)}</div>
                        <div class="game-icon">${game.icon || 'üéÆ'}</div>
                    </div>
                    <div class="game-body">
                        <h3 class="game-title">${game.title}</h3>
                        ${game.trackerHtml ? '<div class="tracker-badge">üìÑ Has Tracker</div>' : ''}
                        <div class="game-meta">
                            <div class="game-meta-item">üéØ ${game.platform}</div>
                            <div class="game-meta-item">‚è±Ô∏è ${game.hours}h</div>
                            <div class="game-meta-item">üìÖ ${formatDate(game.startDate)}</div>
                            <div class="game-meta-item">${game.currentlyPlaying ? 'üéÆ Playing' : ''}</div>
                        </div>
                        <div class="progress-section">
                            <div class="progress-label">
                                <span>Progress</span>
                                <span>${game.progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${game.progress}%"></div>
                            </div>
                        </div>
                        <div class="game-actions-extended" onclick="event.stopPropagation()">
                            ${game.trackerHtml ? `<button class="game-btn" onclick="openTracker('${game.id}')">üìä Tracker</button>` : ''}
                            <button class="game-btn" onclick="editGame('${game.id}')">‚úèÔ∏è Edit</button>
                            <button class="game-btn" onclick="deleteGame('${game.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Filter games
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderGames();
        }

        function filterGames() {
            renderGames();
        }

        // Modal functions
        function openAddModal() {
            currentEditId = null;
            currentTrackerData = null;
            currentImageData = null;
            document.getElementById('modalTitle').textContent = 'Add New Game';
            document.getElementById('gameForm').reset();
            document.getElementById('gameId').value = '';
            document.getElementById('gameTrackerData').value = '';
            document.getElementById('gameImageData').value = '';
            document.getElementById('trackerPreview').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('gameModal').classList.add('active');
        }

        function editGame(id) {
            const game = games.find(g => g.id == id);
            if (!game) return;

            currentEditId = id;
            currentTrackerData = game.trackerHtml || null;
            currentImageData = game.imageData || null;
            
            document.getElementById('modalTitle').textContent = 'Edit Game';
            document.getElementById('gameId').value = game.id;
            document.getElementById('gameTitle').value = game.title;
            document.getElementById('gameIcon').value = game.icon || '';
            document.getElementById('gamePlatform').value = game.platform;
            document.getElementById('gameStatus').value = game.status;
            document.getElementById('gameStartDate').value = game.startDate || '';
            document.getElementById('gameHours').value = game.hours || 0;
            document.getElementById('gameProgress').value = game.progress || 0;
            document.getElementById('gameCurrentlyPlaying').checked = game.currentlyPlaying || false;
            document.getElementById('gameQuote').value = game.quote || '';
            document.getElementById('gameNotes').value = game.notes || '';
            document.getElementById('gameTrackerData').value = game.trackerHtml || '';
            document.getElementById('gameImageData').value = game.imageData || '';
            
            // Show tracker preview if exists
            if (game.trackerHtml) {
                document.getElementById('trackerFileName').textContent = 'Tracker Uploaded';
                document.getElementById('trackerPreview').style.display = 'block';
            } else {
                document.getElementById('trackerPreview').style.display = 'none';
            }
            
            // Show image preview if exists
            if (game.imageData) {
                document.getElementById('previewImg').src = game.imageData;
                document.getElementById('imagePreview').style.display = 'block';
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }

            document.getElementById('gameModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('gameModal').classList.remove('active');
            currentEditId = null;
        }

        function saveGame(event) {
            event.preventDefault();

            const trackerData = document.getElementById('gameTrackerData').value || currentTrackerData;
            const imageData = document.getElementById('gameImageData').value || currentImageData;

            const gameData = {
                id: currentEditId || Date.now(),
                title: document.getElementById('gameTitle').value,
                icon: document.getElementById('gameIcon').value || 'üéÆ',
                imageData: imageData || null,
                platform: document.getElementById('gamePlatform').value,
                status: document.getElementById('gameStatus').value,
                startDate: document.getElementById('gameStartDate').value,
                hours: parseInt(document.getElementById('gameHours').value) || 0,
                progress: parseInt(document.getElementById('gameProgress').value) || 0,
                currentlyPlaying: document.getElementById('gameCurrentlyPlaying').checked,
                quote: document.getElementById('gameQuote').value,
                notes: document.getElementById('gameNotes').value,
                trackerHtml: trackerData || null,
                trackerProgress: currentEditId ? (games.find(g => g.id == currentEditId)?.trackerProgress || {}) : {}
            };

            console.log('Saving game:', gameData.title, 'Has tracker:', !!gameData.trackerHtml, 'Has image:', !!gameData.imageData);

            // If setting as currently playing, unset others
            if (gameData.currentlyPlaying) {
                games.forEach(g => g.currentlyPlaying = false);
            }

            if (currentEditId) {
                const index = games.findIndex(g => g.id == currentEditId);
                games[index] = gameData;
            } else {
                games.push(gameData);
            }

            saveGames();
            
            // Save to Firebase if enabled
            if (firebaseInitialized) {
                saveGameToFirebase(gameData);
            } else if (cloudSyncEnabled) {
                // Fallback to CSV cloud sync
                saveGameToCloud(gameData);
            }
            
            updateUI();
            closeModal();
            
            // Clear temporary data after saving
            currentTrackerData = null;
            currentImageData = null;
        }

        function deleteGame(id) {
            if (!confirm('Are you sure you want to delete this game?')) return;

            games = games.filter(g => g.id != id);
            saveGames();
            updateUI();
            
            // Delete from Firebase if enabled
            if (firebaseInitialized) {
                deleteGameFromFirebase(id);
            } else if (cloudSyncEnabled) {
                // Fallback to CSV cloud sync
                deleteGameFromCloud(id);
            }
        }

        function viewGameDetails(id) {
            const game = games.find(g => g.id == id);
            if (!game) return;

            alert(`${game.icon} ${game.title}\n\n` +
                  `Platform: ${game.platform}\n` +
                  `Status: ${getStatusLabel(game.status)}\n` +
                  `Hours: ${game.hours}\n` +
                  `Progress: ${game.progress}%\n\n` +
                  `${game.quote ? 'Quote: ' + game.quote + '\n\n' : ''}` +
                  `${game.notes ? 'Notes: ' + game.notes : ''}`);
        }

        // Export data
        function exportData() {
            // Show export options
            const format = prompt('Export format:\n1. JSON (backup)\n2. CSV (for Google Sheets)\n\nEnter 1 or 2:', '2');
            
            if (format === '1') {
                exportJSON();
            } else if (format === '2') {
                exportCSV();
            }
        }
        
        function exportJSON() {
            const dataStr = JSON.stringify(games, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'game-library-export.json';
            link.click();
        }
        
        function exportCSV() {
            // Create CSV header
            const headers = ['id', 'title', 'icon', 'imageData', 'platform', 'status', 'startDate', 'hours', 'progress', 'currentlyPlaying', 'quote', 'notes', 'trackerHtml'];
            let csv = headers.join(',') + '\n';
            
            // Add game data
            games.forEach(game => {
                const row = headers.map(header => {
                    let value = game[header] || '';
                    // Convert boolean to string
                    if (header === 'currentlyPlaying') {
                        value = game[header] ? 'TRUE' : 'FALSE';
                    }
                    // Escape quotes and wrap in quotes if contains comma or newline
                    if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('"'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csv += row.join(',') + '\n';
            });
            
            // Download CSV
            const dataBlob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'game-library-export.csv';
            link.click();
            
            // Show instructions
            setTimeout(() => {
                alert('CSV downloaded!\n\nTo update Google Sheets:\n1. Open your Google Sheet\n2. Select all cells (Ctrl+A)\n3. Delete old data\n4. File ‚Üí Import ‚Üí Upload ‚Üí game-library-export.csv\n5. Replace data\n6. Done! Your published CSV will update automatically.');
            }, 500);
        }

        // Helper functions
        function getStatusLabel(status) {
            const labels = {
                'backlog': 'üìö Backlog',
                'playing': 'üéÆ Playing',
                'completed': '‚úÖ Completed',
                'on-hold': '‚è∏Ô∏è On Hold'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Not set';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
        }

        // Close modal on outside click
        document.getElementById('gameModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('trackerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTrackerModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeTrackerModal();
            }
            if (e.key === 'n' && e.ctrlKey) {
                e.preventDefault();
                openAddModal();
            }
        });
    </script>
</body>
</html>
