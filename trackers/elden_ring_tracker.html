<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elden Ring - 100% Walkthrough Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Trajan+Pro:wght@400;700&family=Philosopher:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Philosopher', sans-serif;
            background: #0a0a0a;
            color: #e8e6e3;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.85)),
                        url('https://images.unsplash.com/photo-1538481199705-c710c4e965fc?w=1200') center/cover;
            padding: 60px 20px;
            text-align: center;
            border-bottom: 3px solid #d4af37;
            position: relative;
            min-height: 320px;
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
        }

        h1 {
            font-family: 'Crimson Text', 'Times New Roman', serif;
            font-size: 4em;
            font-weight: 700;
            color: #d4af37;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
            letter-spacing: 8px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 1.2em;
            color: #b8b8b8;
            margin-bottom: 20px;
        }

        .playlist-button {
            display: inline-block;
            padding: 12px 30px;
            background: linear-gradient(135deg, #d4af37, #c49a2e);
            color: #0a0a0a;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .playlist-button:hover {
            background: linear-gradient(135deg, #e6c147, #d4af37);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .section-title {
            font-family: 'Crimson Text', 'Times New Roman', serif;
            font-size: 2em;
            color: #d4af37;
            margin: 30px 0 20px 0;
            padding-left: 15px;
            border-left: 5px solid #d4af37;
            letter-spacing: 2px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a1a, #252525);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #b8b8b8;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .playthrough-selector {
            flex: 1;
            min-width: 200px;
        }

        .playthrough-selector select {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            color: #d4af37;
            border: 2px solid #d4af37;
            border-radius: 5px;
            font-size: 1em;
            font-family: 'Philosopher', sans-serif;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .button {
            padding: 12px 25px;
            background: #1a1a1a;
            color: #d4af37;
            border: 2px solid #d4af37;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-family: 'Philosopher', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
        }

        .button:hover {
            background: #d4af37;
            color: #0a0a0a;
        }

        .button.danger {
            border-color: #c43e3e;
            color: #c43e3e;
        }

        .button.danger:hover {
            background: #c43e3e;
            color: #fff;
        }

        .tabs {
            display: flex;
            gap: 30px;
            border-bottom: 2px solid #333;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #b8b8b8;
            transition: all 0.3s;
            position: relative;
        }

        .tab.active {
            color: #d4af37;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background: #c43e3e;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .video-list {
            display: grid;
            gap: 15px;
        }

        .video-item {
            background: linear-gradient(135deg, #1a1a1a, #252525);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
            position: relative;
        }

        .video-item:hover {
            border-color: #d4af37;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
        }

        .video-item.completed {
            background: linear-gradient(135deg, #1a2e1a, #253025);
            border-color: #4a7c4a;
        }

        .video-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #d4af37;
            flex-shrink: 0;
        }

        .video-info {
            flex: 1;
        }

        .video-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #e8e6e3;
            margin-bottom: 5px;
        }

        .video-item.completed .video-title {
            color: #8bc98b;
        }

        .video-duration {
            color: #b8b8b8;
            font-size: 0.9em;
        }

        .video-part {
            background: #d4af37;
            color: #0a0a0a;
            padding: 8px 16px;
            border-radius: 5px;
            font-weight: 700;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .timestamp-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timestamp-label {
            color: #b8b8b8;
            font-size: 0.9em;
            min-width: 80px;
        }

        .timestamp-input {
            padding: 8px 12px;
            background: #0a0a0a;
            border: 1px solid #d4af37;
            border-radius: 5px;
            color: #d4af37;
            font-family: 'Philosopher', sans-serif;
            width: 120px;
        }

        .timestamp-display {
            color: #d4af37;
            font-weight: 600;
        }

        .achievements-grid {
            display: grid;
            gap: 30px;
        }

        .achievement-category {
            background: linear-gradient(135deg, #1a1a1a, #252525);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 25px;
        }

        .category-header {
            font-family: 'Crimson Text', 'Times New Roman', serif;
            font-size: 1.5em;
            font-weight: 700;
            color: #d4af37;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #d4af37;
            letter-spacing: 1px;
        }

        .achievement-list {
            display: grid;
            gap: 15px;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .achievement-item:hover {
            border-color: #d4af37;
        }

        .achievement-item.completed {
            background: linear-gradient(135deg, #1a2e1a, #253025);
            border-color: #4a7c4a;
        }

        .achievement-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #d4af37;
            flex-shrink: 0;
        }

        .achievement-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8em;
            flex-shrink: 0;
            text-transform: uppercase;
        }

        .badge-bronze {
            background: linear-gradient(135deg, #cd7f32, #8b5a2b);
            color: #fff;
        }

        .badge-silver {
            background: linear-gradient(135deg, #c0c0c0, #808080);
            color: #0a0a0a;
        }

        .badge-gold {
            background: linear-gradient(135deg, #ffd700, #d4af37);
            color: #0a0a0a;
        }

        .badge-platinum {
            background: linear-gradient(135deg, #e5e4e2, #a8a8a8);
            color: #0a0a0a;
        }

        .achievement-details {
            flex: 1;
        }

        .achievement-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #e8e6e3;
            margin-bottom: 5px;
        }

        .achievement-item.completed .achievement-name {
            color: #8bc98b;
        }

        .achievement-description {
            color: #b8b8b8;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .button-group {
                width: 100%;
            }

            .button {
                flex: 1;
            }

            .video-item {
                flex-wrap: wrap;
            }

            .timestamp-section {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="headerTitle">ELDEN RING</h1>
        <div class="subtitle" id="headerSubtitle">100% Complete Walkthrough Tracker</div>
        <a href="https://youtube.com/playlist?list=PL7RtZMiaOk8gdRf130w4gFYyhstL-5VRh&si=QQ6KPf-AL36vOcUV" target="_blank" class="playlist-button">
            üì∫ View FightinCowboy's Playlist
        </a>
    </div>

    <div class="container">
        <div class="section-title">FightinCowboy's 100% Walkthrough</div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="completion-percentage">0%</div>
                <div class="stat-label">Completion</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="videos-watched">0/82</div>
                <div class="stat-label">Videos Watched</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="time-watched">0h 0m</div>
                <div class="stat-label">Time Watched</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="time-percentage">0%</div>
                <div class="stat-label">Time Progress</div>
            </div>
        </div>

        <div class="controls">
            <div class="playthrough-selector">
                <select id="playthrough-select">
                    <option value="first">First Playthrough</option>
                    <option value="ng+1">New Game+ 1</option>
                    <option value="ng+2">New Game+ 2</option>
                    <option value="ng+3">New Game+ 3</option>
                    <option value="ng+4">New Game+ 4</option>
                    <option value="ng+5">New Game+ 5</option>
                    <option value="ng+6">New Game+ 6</option>
                    <option value="ng+7">New Game+ 7</option>
                    <option value="ng+8">New Game+ 8</option>
                    <option value="ng+9">New Game+ 9</option>
                    <option value="ng+10">New Game+ 10</option>
                </select>
            </div>
            <div class="button-group">
                <button class="button" onclick="exportProgress()">üì• Export Progress</button>
                <button class="button danger" onclick="resetCurrentPlaythrough()">üîÑ Reset Current</button>
                <button class="button danger" onclick="resetAllProgress()">‚ö†Ô∏è Reset All</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('walkthrough')">Walkthrough</div>
            <div class="tab" onclick="switchTab('achievements')">Achievements</div>
        </div>

        <div id="walkthrough-content" class="tab-content active">
            <div class="video-list" id="video-list"></div>
        </div>

        <div id="achievements-content" class="tab-content">
            <div class="achievements-grid" id="achievements-grid"></div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GAME LIBRARY INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Detect if running inside Game Library or standalone
        const isInGameLibrary = window.parent && window.parent !== window;
        let gameId = null;
        let trackerProgress = {};
        let gameImageUrl = null;
        
        // First, try to read from URL hash (works for external trackers loaded via iframe.src)
        const hash = window.location.hash.substring(1);
        if (hash) {
            const params = new URLSearchParams(hash);
            const hashGameId = params.get('gameId');
            const progressParam = params.get('progress');
            const imageParam = params.get('image');
            
            if (hashGameId) {
                gameId = hashGameId;
                console.log('üìç Game ID from URL hash:', gameId);
            }
            
            if (imageParam) {
                gameImageUrl = decodeURIComponent(imageParam);
                console.log('üñºÔ∏è Game image URL:', gameImageUrl);
            }
            
            if (progressParam) {
                try {
                    trackerProgress = JSON.parse(decodeURIComponent(progressParam));
                    console.log('üì¶ Progress from URL hash:', trackerProgress);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Failed to parse progress from URL hash:', e);
                }
            }
        }
        
        // Fallback: check for injected window properties (for inline trackers)
        if (!gameId && isInGameLibrary) {
            gameId = window.gameLibraryGameId || null;
            trackerProgress = window.trackerProgress || {};
            gameImageUrl = window.gameImageUrl || null;
            console.log('üéÆ Using injected Game Library data');
        }
        
        console.log('üéÆ Running in ' + (isInGameLibrary ? 'Game Library' : 'Standalone') + ' mode');
        console.log('üìä Game ID:', gameId);
        console.log('üìä Loaded progress:', trackerProgress);
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VIDEO DATA
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const videos = [
            { part: 1, title: "Getting Started in the Lands Between", duration: "37:27" },
            { part: 2, title: "Limgrave Starting Loop", duration: "37:27" },
            { part: 3, title: "Liurnia & Caelid Loop", duration: "38:40" },
            { part: 4, title: "Round Table & Combat Specifics", duration: "33:25" },
            { part: 5, title: "Murkwater, Agheel, & Limgrave Mines", duration: "42:31" },
            { part: 6, title: "Margit, the Fell Omen", duration: "28:35" },
            { part: 7, title: "Limgrave Field Bosses", duration: "35:58" },
            { part: 8, title: "Weeping Peninsula", duration: "32:50" },
            { part: 9, title: "Finishing the Peninsula", duration: "35:05" },
            { part: 10, title: "Castle Morne", duration: "32:48" },
            { part: 11, title: "Stormveil Castle", duration: "39:20" },
            { part: 12, title: "Godrick the Grafted", duration: "38:36" },
            { part: 13, title: "Fringefolk Hero's Grave & Finishing Limgrave", duration: "47:33" },
            { part: 14, title: "Southeast Liurnia & Cliffbottom Catacombs", duration: "39:06" },
            { part: 15, title: "South Liurnia and the Rose Church", duration: "35:22" },
            { part: 16, title: "Village of the Albinaurics", duration: "39:34" },
            { part: 17, title: "West Liurnia", duration: "34:03" },
            { part: 18, title: "Glintstone Dragon & Crystal Tunnels", duration: "42:33" },
            { part: 19, title: "Academy of Raya Lucaria", duration: "31:02" },
            { part: 20, title: "God-Slaying Armament (Patched, Read Pinned Comment)", duration: "44:26" },
            { part: 21, title: "Red Wolf of Radagon", duration: "58:06" },
            { part: 22, title: "Rennala & Magma Wyrm Makar", duration: "36:07" },
            { part: 23, title: "Royal Knight Loretta", duration: "32:09" },
            { part: 24, title: "Eastern Liurnia & Black Knife Catacombs", duration: "34:24" },
            { part: 25, title: "Jarburg (Read Pinned Comment) & Carian Studyhall", duration: "33:18" },
            { part: 26, title: "Dragonkin Soldier of Nokstella", duration: "36:43" },
            { part: 27, title: "Ancestor Spirit", duration: "32:23" },
            { part: 28, title: "Caelid", duration: "35:35" },
            { part: 29, title: "Swamp of Aeonia", duration: "34:35" },
            { part: 30, title: "Selia Town of Sorcery", duration: "31:09" },
            { part: 31, title: "Caelid Field Bosses", duration: "34:07" },
            { part: 32, title: "Castle Redmane", duration: "28:18" },
            { part: 33, title: "Starscourge Radahn", duration: "39:10" },
            { part: 34, title: "Nokron & Night's Sacred Ground", duration: "32:35" },
            { part: 35, title: "Ancestral Woods & Cursemark of Death", duration: "36:42" },
            { part: 36, title: "Siofra Aquaduct", duration: "27:04" },
            { part: 37, title: "Nokstella", duration: "30:44" },
            { part: 38, title: "Lake of Rot", duration: "26:03" },
            { part: 39, title: "Astel, Naturalborn of the Void", duration: "31:50" },
            { part: 40, title: "Deeproot Depths", duration: "39:52" },
            { part: 41, title: "Lichdragon Fortissax & Altus Maps", duration: "35:31" },
            { part: 42, title: "Recusant Questlines", duration: "38:00" },
            { part: 43, title: "Wyndham & Old Altus", duration: "31:09" },
            { part: 44, title: "Shaded Castle", duration: "35:54" },
            { part: 45, title: "Sellen's Questline", duration: "27:41" },
            { part: 46, title: "Mount Gelmir", duration: "36:29" },
            { part: 47, title: "Volcano Manor", duration: "36:29" },
            { part: 48, title: "Altus Plateau", duration: "37:20" },
            { part: 49, title: "Dominula & Altus Tunnel", duration: "34:32" },
            { part: 50, title: "Lansseax and Sainted Hero's Grave", duration: "28:34" },
            { part: 51, title: "Capital Outskirts", duration: "34:43" },
            { part: 52, title: "Auriza Hero's Grave & Side Tomb", duration: "38:55" },
            { part: 53, title: "Upper Caelid", duration: "38:10" },
            { part: 54, title: "Divine Tower of Caelid & War-Dead Catacombs", duration: "28:58" },
            { part: 55, title: "Moonlight Altar", duration: "36:43" },
            { part: 56, title: "Leyndell, the Royal Capital", duration: "28:14" },
            { part: 57, title: "Lower Leyndell", duration: "35:21" },
            { part: 58, title: "Morgott, the Omen King", duration: "33:59" },
            { part: 59, title: "Subterranean Shunning-Grounds", duration: "32:15" },
            { part: 60, title: "Mohg, the Omen", duration: "31:58" },
            { part: 61, title: "Frenzy Flame & Forbidden Lands", duration: "31:44" },
            { part: 62, title: "Giants' Mountaintop Catacombs", duration: "39:21" },
            { part: 63, title: "Rykard, Lord of Blasphemy", duration: "35:07" },
            { part: 64, title: "Freezing Lake & Guardians Garrison", duration: "33:17" },
            { part: 65, title: "Castle Sol & Mountaintop Field Bosses", duration: "39:16" },
            { part: 66, title: "Fire Giant & Giant Conqueror's Tomb", duration: "34:15" },
            { part: 67, title: "Hidden Path to the Haligtree", duration: "28:25" },
            { part: 68, title: "Consecrated Snowfield Catacombs", duration: "37:46" },
            { part: 69, title: "Snowfield Nightriders & Deathbird", duration: "29:00" },
            { part: 70, title: "Yelough Anix & Ordina", duration: "33:58" },
            { part: 71, title: "Mohgwyn Palace", duration: "32:58" },
            { part: 72, title: "Crumbling Farum Azula", duration: "32:27" },
            { part: 73, title: "Godskin Duo", duration: "29:50" },
            { part: 74, title: "Dragon Temple & Alexander", duration: "30:34" },
            { part: 75, title: "Dragonlord Placidusax", duration: "32:21" },
            { part: 76, title: "Haligtree Canopy", duration: "33:40" },
            { part: 77, title: "Prayer Room", duration: "28:55" },
            { part: 78, title: "Elphael Inner Wall", duration: "33:41" },
            { part: 79, title: "Malenia & Maliketh", duration: "30:58" },
            { part: 80, title: "Ashen Capital & Hoarah Loux", duration: "30:28" },
            { part: 81, title: "Elden Beast & Endings", duration: "35:24" }
        ];

        const achievements = {
            "Story Bosses": [
                { name: "Margit, the Fell Omen", description: "Defeated Margit, the Fell Omen", grade: "gold" },
                { name: "Godrick the Grafted", description: "Defeated Godrick the Grafted", grade: "gold" },
                { name: "Rennala, Queen of the Full Moon", description: "Defeated Rennala, Queen of the Full Moon", grade: "gold" },
                { name: "Starscourge Radahn", description: "Defeated Starscourge Radahn", grade: "gold" },
                { name: "Morgott, the Omen King", description: "Defeated Morgott, the Omen King", grade: "gold" },
                { name: "Fire Giant", description: "Defeated the Fire Giant", grade: "gold" },
                { name: "Malenia, Blade of Miquella", description: "Defeated Malenia, Blade of Miquella", grade: "platinum" },
                { name: "Godfrey, First Elden Lord", description: "Defeated Godfrey, First Elden Lord", grade: "gold" },
                { name: "Elden Beast", description: "Defeated the Elden Beast", grade: "platinum" }
            ],
            "Great Runes": [
                { name: "Godrick's Great Rune", description: "Acquired Godrick's Great Rune", grade: "silver" },
                { name: "Rennala's Great Rune", description: "Acquired Rennala's Great Rune", grade: "silver" },
                { name: "Radahn's Great Rune", description: "Acquired Radahn's Great Rune", grade: "silver" },
                { name: "Morgott's Great Rune", description: "Acquired Morgott's Great Rune", grade: "silver" },
                { name: "Rykard's Great Rune", description: "Acquired Rykard's Great Rune", grade: "silver" },
                { name: "Mohg's Great Rune", description: "Acquired Mohg's Great Rune", grade: "silver" },
                { name: "Malenia's Great Rune", description: "Acquired Malenia's Great Rune", grade: "silver" }
            ],
            "Legendary Items": [
                { name: "Legendary Armaments", description: "Acquired all legendary armaments", grade: "gold" },
                { name: "Legendary Ashen Remains", description: "Acquired all legendary ashen remains", grade: "gold" },
                { name: "Legendary Sorceries and Incantations", description: "Acquired all legendary sorceries and incantations", grade: "gold" },
                { name: "Legendary Talismans", description: "Acquired all legendary talismans", grade: "gold" }
            ],
            "Endings": [
                { name: "Age of Fracture", description: "Achieved the Age of Fracture ending", grade: "gold" },
                { name: "Age of the Duskborn", description: "Achieved the Age of the Duskborn ending", grade: "gold" },
                { name: "Blessing of Despair", description: "Achieved the Blessing of Despair ending", grade: "gold" },
                { name: "Age of Order", description: "Achieved the Age of Order ending", grade: "gold" },
                { name: "Age of Stars", description: "Achieved the Age of Stars ending", grade: "gold" },
                { name: "Lord of Frenzied Flame", description: "Achieved the Lord of Frenzied Flame ending", grade: "gold" }
            ],
            "Optional Bosses": [
                { name: "Dragonlord Placidusax", description: "Defeated Dragonlord Placidusax", grade: "silver" },
                { name: "Mohg, Lord of Blood", description: "Defeated Mohg, Lord of Blood", grade: "silver" },
                { name: "Lichdragon Fortissax", description: "Defeated Lichdragon Fortissax", grade: "silver" },
                { name: "Astel, Naturalborn of the Void", description: "Defeated Astel, Naturalborn of the Void", grade: "silver" },
                { name: "Rykard, Lord of Blasphemy", description: "Defeated Rykard, Lord of Blasphemy", grade: "gold" },
                { name: "Maliketh, the Black Blade", description: "Defeated Maliketh, the Black Blade", grade: "gold" },
                { name: "Hoarah Loux, Warrior", description: "Defeated Hoarah Loux, Warrior", grade: "gold" }
            ],
            "Exploration": [
                { name: "Roundtable Hold", description: "Reached Roundtable Hold", grade: "bronze" },
                { name: "Liurnia of the Lakes", description: "Reached Liurnia of the Lakes", grade: "bronze" },
                { name: "Altus Plateau", description: "Reached the Altus Plateau", grade: "bronze" },
                { name: "Mt. Gelmir", description: "Reached Mt. Gelmir", grade: "bronze" },
                { name: "Leyndell, Royal Capital", description: "Reached Leyndell, Royal Capital", grade: "silver" },
                { name: "Mountaintops of the Giants", description: "Reached Mountaintops of the Giants", grade: "silver" },
                { name: "Crumbling Farum Azula", description: "Reached Crumbling Farum Azula", grade: "silver" },
                { name: "Miquella's Haligtree", description: "Reached Miquella's Haligtree", grade: "silver" },
                { name: "Siofra River", description: "Reached Siofra River", grade: "bronze" },
                { name: "Nokron, Eternal City", description: "Reached Nokron, Eternal City", grade: "silver" },
                { name: "Lake of Rot", description: "Reached the Lake of Rot", grade: "bronze" },
                { name: "Deeproot Depths", description: "Reached Deeproot Depths", grade: "silver" }
            ],
            "Progression": [
                { name: "Elden Lord", description: "Became Elden Lord", grade: "platinum" },
                { name: "Shardbearer", description: "Defeated a demigod and obtained a Great Rune", grade: "silver" },
                { name: "Great Rune", description: "Activated a Great Rune at a Divine Tower", grade: "bronze" },
                { name: "Legendary Tarnished", description: "Achieved all endings", grade: "platinum" }
            ]
        };

        let currentPlaythrough = 1;
        let progress = loadProgress();

        function loadProgress() {
            // Load from Game Library if available
            if (trackerProgress && Object.keys(trackerProgress).length > 0) {
                console.log('üì• Loading progress from Game Library:', trackerProgress);
                console.log('   - Keys in trackerProgress:', Object.keys(trackerProgress));
                
                // Check if this is a flat structure (old format) or nested structure (new format)
                const hasCheckboxKeys = Object.keys(trackerProgress).some(key => key.startsWith('checkbox_'));
                
                if (hasCheckboxKeys) {
                    console.log('   - Detected FLAT data structure (old format)');
                    
                    // Old flat format - all checkboxes at top level
                    // Convert to nested structure: playthrough -> videos
                    const normalizedVideos = {};
                    const normalizedTimestamps = {};
                    const normalizedAchievements = {};
                    
                    Object.keys(trackerProgress).forEach(key => {
                        if (key.startsWith('checkbox_')) {
                            // Extract numeric index
                            const match = key.match(/checkbox_(\d+)_/);
                            if (match) {
                                const index = parseInt(match[1]);
                                normalizedVideos[index] = trackerProgress[key];
                            }
                        } else if (key === 'currentPlaythrough') {
                            currentPlaythrough = trackerProgress[key];
                        } else if (key !== 'lastUpdated') {
                            // Might be achievement or timestamp
                            if (key.includes('timestamp')) {
                                normalizedTimestamps[key] = trackerProgress[key];
                            } else {
                                normalizedAchievements[key] = trackerProgress[key];
                            }
                        }
                    });
                    
                    console.log('   - Converted videos:', Object.keys(normalizedVideos).length, 'videos');
                    console.log('   - Sample:', Object.keys(normalizedVideos).slice(0, 5));
                    
                    // Return as playthrough 1 data
                    return {
                        1: {
                            videos: normalizedVideos,
                            timestamps: normalizedTimestamps,
                            achievements: normalizedAchievements
                        }
                    };
                } else {
                    console.log('   - Detected NESTED data structure (new format)');
                    
                    // New nested format - playthrough -> videos structure
                    const normalizedProgress = {};
                    
                    Object.keys(trackerProgress).forEach(key => {
                        if (key === 'lastUpdated') {
                            return;
                        }
                        
                        if (key === 'currentPlaythrough') {
                            currentPlaythrough = trackerProgress[key];
                            return;
                        }
                        
                        const playthroughData = trackerProgress[key];
                        
                        if (typeof playthroughData === 'object' && playthroughData !== null) {
                            const normalizedVideos = {};
                            const normalizedTimestamps = playthroughData.timestamps || {};
                            const normalizedAchievements = playthroughData.achievements || {};
                            
                            const videosData = playthroughData.videos || {};
                            Object.keys(videosData).forEach(videoKey => {
                                let index;
                                if (videoKey.startsWith('checkbox_')) {
                                    const match = videoKey.match(/checkbox_(\d+)_/);
                                    if (match) {
                                        index = parseInt(match[1]);
                                    }
                                } else {
                                    index = parseInt(videoKey);
                                }
                                
                                if (!isNaN(index)) {
                                    normalizedVideos[index] = videosData[videoKey];
                                }
                            });
                            
                            normalizedProgress[key] = {
                                videos: normalizedVideos,
                                timestamps: normalizedTimestamps,
                                achievements: normalizedAchievements
                            };
                        }
                    });
                    
                    console.log('   - Playthroughs found:', Object.keys(normalizedProgress));
                    return normalizedProgress;
                }
            }
            
            // Otherwise try localStorage
            const saved = localStorage.getItem('eldenRingProgress');
            if (saved) {
                console.log('üì¶ Loading from localStorage');
                return JSON.parse(saved);
            }
            
            console.log('‚ÑπÔ∏è No saved progress (new tracker)');
            return {};
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CALCULATE TIME WATCHED
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function calculateTimeWatched(playthrough = null) {
            const targetPlaythrough = playthrough || currentPlaythrough;
            const currentData = progress[targetPlaythrough];
            if (!currentData) return { hours: 0, minutes: 0, totalMinutes: 0 };
            
            let completedMinutes = 0;
            
            videos.forEach((video, index) => {
                if (currentData.videos && currentData.videos[index]) {
                    completedMinutes += parseDuration(video.duration);
                }
            });
            
            const hours = Math.floor(completedMinutes / 60);
            const minutes = Math.floor(completedMinutes % 60);
            
            return { hours, minutes, totalMinutes: completedMinutes };
        }
        
        function calculateTotalTimeAllPlaythroughs() {
            let totalMinutes = 0;
            
            // Iterate through all possible playthroughs
            for (let pt = 1; pt <= 10; pt++) {
                if (progress[pt] && progress[pt].videos) {
                    videos.forEach((video, index) => {
                        if (progress[pt].videos[index]) {
                            totalMinutes += parseDuration(video.duration);
                        }
                    });
                }
            }
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            
            return { hours, minutes, totalMinutes };
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SAVE PROGRESS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function saveProgress() {
            // Save to localStorage
            localStorage.setItem('eldenRingProgress', JSON.stringify(progress));
            
            // Save to Game Library if available
            saveProgressToGameLibrary();
        }
        
        function saveProgressToGameLibrary() {
            if (!isInGameLibrary || !gameId) {
                return;
            }
            
            const progressToSave = {
                ...progress,
                currentPlaythrough: currentPlaythrough,
                lastUpdated: new Date().toISOString()
            };
            
            // Calculate stats for display
            const currentData = getCurrentProgress();
            const completedVideos = Object.keys(currentData.videos).filter(k => currentData.videos[k]).length;
            const totalVideos = videos.length;
            const completionPercent = Math.round((completedVideos / totalVideos) * 100);
            
            // Calculate current playthrough time (for console log)
            const currentTimeData = calculateTimeWatched();
            
            // Calculate TOTAL time across all playthroughs (for Game Library card)
            const totalTimeData = calculateTotalTimeAllPlaythroughs();
            
            // Send to Game Library
            window.parent.postMessage({
                type: 'TRACKER_PROGRESS_UPDATE',
                gameId: gameId,
                checkboxId: 'elden_ring_complete_data',
                checked: true,
                allProgress: progressToSave
            }, '*');
            
            // Also send overall game stats with TOTAL cumulative hours
            window.parent.postMessage({
                type: 'TRACKER_SYNC',
                gameId: gameId,
                hours: totalTimeData.hours + (totalTimeData.minutes >= 30 ? 1 : 0),
                progress: completionPercent
            }, '*');
            
            console.log('‚úÖ Synced to Game Library:', {
                playthrough: currentPlaythrough,
                completion: completionPercent + '%',
                videos: completedVideos + '/' + totalVideos,
                achievements: Object.keys(currentData.achievements).length,
                currentPlaythroughTime: currentTimeData.hours + 'H ' + currentTimeData.minutes + 'M',
                totalTimeAllPlaythroughs: totalTimeData.hours + 'H ' + totalTimeData.minutes + 'M'
            });
            
            showSyncNotification();
        }
        
        function showSyncNotification() {
            if (document.querySelector('.sync-notification')) return;
            
            const notification = document.createElement('div');
            notification.className = 'sync-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                z-index: 99999;
                font-weight: 600;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = '‚úì Synced to Library';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function getCurrentProgress() {
            if (!progress[currentPlaythrough]) {
                progress[currentPlaythrough] = {
                    videos: {},
                    timestamps: {},
                    achievements: {}
                };
            }
            return progress[currentPlaythrough];
        }

        function parseDuration(duration) {
            const parts = duration.split(':').map(Number);
            if (parts.length === 2) {
                return parts[0] * 60 + parts[1];
            } else if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return 0;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        function updateStats() {
            const currentProgress = getCurrentProgress();
            const completed = Object.values(currentProgress.videos).filter(v => v).length;
            const total = videos.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            const totalSeconds = videos.reduce((sum, v) => sum + parseDuration(v.duration), 0);
            const watchedSeconds = videos.reduce((sum, v, i) => {
                return sum + (currentProgress.videos[i] ? parseDuration(v.duration) : 0);
            }, 0);
            const timePercentage = totalSeconds > 0 ? Math.round((watchedSeconds / totalSeconds) * 100) : 0;

            document.getElementById('completion-percentage').textContent = `${percentage}%`;
            document.getElementById('videos-watched').textContent = `${completed}/${total}`;
            document.getElementById('time-watched').textContent = formatTime(watchedSeconds);
            document.getElementById('time-percentage').textContent = `${timePercentage}%`;

            // Update achievement stats
            const achievementCategories = Object.keys(achievements);
            let totalAchievements = 0;
            let completedAchievements = 0;
            achievementCategories.forEach(category => {
                achievements[category].forEach(achievement => {
                    totalAchievements++;
                    const key = `${category}-${achievement.name}`;
                    if (currentProgress.achievements[key]) {
                        completedAchievements++;
                    }
                });
            });
        }

        function renderVideos() {
            const currentProgress = getCurrentProgress();
            const videoList = document.getElementById('video-list');
            videoList.innerHTML = '';

            videos.forEach((video, index) => {
                const isCompleted = currentProgress.videos[index] || false;
                const timestamp = currentProgress.timestamps[index] || '';

                const videoItem = document.createElement('div');
                videoItem.className = `video-item ${isCompleted ? 'completed' : ''}`;
                
                videoItem.innerHTML = `
                    <input type="checkbox" class="video-checkbox" 
                           ${isCompleted ? 'checked' : ''} 
                           onchange="toggleVideo(${index})">
                    <div class="video-info">
                        <div class="video-title">Part ${video.part} - ${video.title}</div>
                        <div class="video-duration">Duration: ${video.duration}</div>
                        ${!isCompleted ? `
                            <div class="timestamp-section">
                                <span class="timestamp-label">Paused At:</span>
                                <input type="text" 
                                       class="timestamp-input" 
                                       placeholder="00:00" 
                                       value="${timestamp}"
                                       onchange="updateTimestamp(${index}, this.value)">
                                ${timestamp ? `<span class="timestamp-display">${timestamp}</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="video-part">${String(video.part).padStart(2, '0')}</div>
                `;
                
                videoList.appendChild(videoItem);
            });
        }

        function toggleVideo(index) {
            const currentProgress = getCurrentProgress();
            currentProgress.videos[index] = !currentProgress.videos[index];
            
            if (currentProgress.videos[index]) {
                delete currentProgress.timestamps[index];
            }
            
            saveProgress();
            updateStats();
            renderVideos();
        }

        function updateTimestamp(index, value) {
            const currentProgress = getCurrentProgress();
            if (value.trim()) {
                currentProgress.timestamps[index] = value.trim();
            } else {
                delete currentProgress.timestamps[index];
            }
            saveProgress();
            renderVideos();
        }

        function renderAchievements() {
            const currentProgress = getCurrentProgress();
            const achievementsGrid = document.getElementById('achievements-grid');
            achievementsGrid.innerHTML = '';

            Object.keys(achievements).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'achievement-category';
                
                let categoryHTML = `<div class="category-header">${category}</div><div class="achievement-list">`;
                
                achievements[category].forEach(achievement => {
                    const key = `${category}-${achievement.name}`;
                    const isCompleted = currentProgress.achievements[key] || false;
                    
                    categoryHTML += `
                        <div class="achievement-item ${isCompleted ? 'completed' : ''}">
                            <input type="checkbox" 
                                   class="achievement-checkbox" 
                                   ${isCompleted ? 'checked' : ''}
                                   onchange="toggleAchievement('${key}')">
                            <div class="achievement-badge badge-${achievement.grade}">
                                ${achievement.grade.substring(0, 3).toUpperCase()}
                            </div>
                            <div class="achievement-details">
                                <div class="achievement-name">${achievement.name}</div>
                                <div class="achievement-description">${achievement.description}</div>
                            </div>
                        </div>
                    `;
                });
                
                categoryHTML += '</div>';
                categoryDiv.innerHTML = categoryHTML;
                achievementsGrid.appendChild(categoryDiv);
            });
        }

        function toggleAchievement(key) {
            const currentProgress = getCurrentProgress();
            currentProgress.achievements[key] = !currentProgress.achievements[key];
            saveProgress();
            updateStats();
            renderAchievements();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        function exportProgress() {
            const dataStr = JSON.stringify(progress, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'elden-ring-progress.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function resetCurrentPlaythrough() {
            if (confirm(`Are you sure you want to reset all progress for ${document.getElementById('playthrough-select').selectedOptions[0].text}? This cannot be undone.`)) {
                delete progress[currentPlaythrough];
                saveProgress();
                updateStats();
                renderVideos();
                renderAchievements();
            }
        }

        function resetAllProgress() {
            if (confirm('Are you sure you want to reset ALL progress for ALL playthroughs? This cannot be undone.')) {
                if (confirm('This will delete everything. Are you absolutely sure?')) {
                    progress = {};
                    saveProgress();
                    updateStats();
                    renderVideos();
                    renderAchievements();
                }
            }
        }

        document.getElementById('playthrough-select').addEventListener('change', function() {
            currentPlaythrough = this.value;
            updateStats();
            renderVideos();
            renderAchievements();
        });

        // Listen for manual sync requests from Game Library
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'REQUEST_PROGRESS_SYNC') {
                console.log('üì• Received manual sync request from Game Library');
                saveProgressToGameLibrary();
            }
        });

        // Apply header background image if available
        function applyHeaderBackground() {
            const header = document.querySelector('.header');
            const title = document.getElementById('headerTitle');
            const subtitle = document.getElementById('headerSubtitle');
            
            if (gameImageUrl && header) {
                header.style.background = `
                    linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.85)),
                    url('${gameImageUrl}') center/cover
                `;
                
                if (title) title.style.display = 'none';
                if (subtitle) subtitle.style.display = 'none';
                
                console.log('üñºÔ∏è Applied header background image and hid text');
            } else {
                if (title) title.style.display = '';
                if (subtitle) subtitle.style.display = '';
                console.log('üìù No image URL - showing header text');
            }
        }

        // Initialize
        updateStats();
        renderVideos();
        renderAchievements();
        applyHeaderBackground();
    </script>
</body>
</html>