<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Black Myth: Wukong - Journey Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Noto+Serif+SC:wght@400;600;700;900&family=Crimson+Pro:wght@400;600&family=Trade+Winds&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gold: #D4AF37;
            --red: #C41E3A;
            --dark-red: #8B0000;
            --black: #0A0A0A;
            --dark-brown: #1A0F0A;
            --charcoal: #1C1C1C;
            --stone: #2A2520;
            --light-stone: #3A342F;
            --off-white: #F5F0E8;
            --paper: #E8DCC8;
            --bronze: #CD7F32;
            --jade: #00A86B;
            --shadow: rgba(0, 0, 0, 0.8);
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: linear-gradient(135deg, var(--dark-brown) 0%, var(--black) 50%, var(--charcoal) 100%);
            color: var(--off-white);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 0, 0, 0.03) 2px,
                    rgba(0, 0, 0, 0.03) 4px
                );
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 2;
        }

        header {
            text-align: center;
            padding: 0;
            position: relative;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(28, 28, 28, 0.95) 100%);
            border: 2px solid rgba(58, 52, 47, 0.5);
            border-radius: 16px;
            margin-bottom: 2rem;
            animation: fadeInDown 0.8s ease-out;
            box-shadow: 0 8px 32px var(--shadow);
            min-height: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* When a background image URL is provided via CSS variable */
        header[style*="--header-bg"] {
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.85) 0%, rgba(28, 28, 28, 0.85) 100%),
                        var(--header-bg) center/cover no-repeat;
        }


        h1 {
            font-family: 'Trade Winds', cursive;
            font-size: 3rem;
            font-weight: 400;
            color: #F5F0E8;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            text-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(212, 175, 55, 0.3);
            line-height: 1.3;
        }

        h1 .subtitle-inline {
            display: block;
            font-family: 'Trade Winds', cursive;
            font-size: 0.85em;
            letter-spacing: 0.15em;
            margin-top: 0.2rem;
        }

        .subtitle {
            font-family: 'Noto Serif SC', serif;
            font-size: 0.9rem;
            color: #E8DCC8;
            letter-spacing: 0.3em;
            font-weight: 400;
            text-transform: uppercase;
            margin-bottom: 2rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        }

        .youtube-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.9rem 2.5rem;
            background: #FF0000;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
            text-transform: uppercase;
            border: none;
        }

        .youtube-link:hover {
            background: #CC0000;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.4);
        }

        .youtube-icon {
            width: 20px;
            height: 20px;
        }

        .tabs {
            display: flex;
            gap: 3rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--stone);
            animation: fadeIn 1s ease-out 0.3s both;
        }

        .tab {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            font-weight: 400;
            padding: 0.75rem 0;
            background: transparent;
            color: var(--paper);
            border: none;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--red);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tab:hover {
            color: var(--gold);
        }

        .tab.active {
            color: var(--red);
        }

        .tab.active::after {
            transform: scaleX(1);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 0;
            background: transparent;
            border-radius: 0;
            border: none;
            box-shadow: none;
        }

        .playthrough-selector {
            flex: 0 0 auto;
            min-width: 250px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .playthrough-selector label {
            font-family: 'Cinzel', serif;
            font-weight: 400;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 0;
            color: var(--paper);
            letter-spacing: 0.05em;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .playthrough-selector select {
            padding: 0.6rem 1rem;
            background: rgba(26, 15, 10, 0.6);
            color: var(--off-white);
            border: 1px solid var(--stone);
            border-radius: 4px;
            font-size: 0.95rem;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .playthrough-selector select:hover {
            border-color: var(--bronze);
            background: rgba(26, 15, 10, 0.8);
        }

        .playthrough-selector select:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: nowrap;
        }

        button:not(.tab) {
            padding: 0.6rem 1.5rem;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            font-size: 0.85rem;
            border: 1px solid;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .btn-export {
            background: transparent;
            color: var(--paper);
            border-color: var(--stone);
        }

        .btn-export:hover {
            background: rgba(0, 168, 107, 0.1);
            border-color: var(--jade);
            color: var(--jade);
            transform: none;
            box-shadow: none;
        }

        .btn-reset {
            background: transparent;
            color: var(--paper);
            border-color: var(--stone);
        }

        .btn-reset:hover {
            background: rgba(205, 127, 50, 0.1);
            border-color: var(--bronze);
            color: var(--bronze);
            transform: none;
            box-shadow: none;
        }

        .btn-reset-all {
            background: transparent;
            color: var(--paper);
            border-color: var(--stone);
        }

        .btn-reset-all:hover {
            background: rgba(196, 30, 58, 0.1);
            border-color: var(--red);
            color: var(--red);
            transform: none;
            box-shadow: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, rgba(26, 15, 10, 0.6) 0%, rgba(28, 28, 28, 0.6) 100%);
            border: 2px solid var(--stone);
            border-radius: 12px;
            overflow: hidden;
        }

        .stat-card {
            background: transparent;
            padding: 2rem 1.5rem;
            border-radius: 0;
            border: none;
            border-right: 1px solid var(--stone);
            box-shadow: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-align: center;
        }

        .stat-card:last-child {
            border-right: none;
        }

        .stat-card:hover {
            transform: none;
            background: rgba(212, 175, 55, 0.05);
            box-shadow: none;
        }

        .stat-card::before {
            display: none;
        }

        .stat-label {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            color: var(--paper);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 1rem;
            font-weight: 400;
        }

        .stat-value {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
        }

        .progress-bar-container {
            display: none;
        }

        .video-list {
            display: grid;
            gap: 1rem;
        }

        .video-item {
            background: linear-gradient(135deg, rgba(26, 15, 10, 0.4) 0%, rgba(28, 28, 28, 0.4) 100%);
            padding: 1.5rem 2rem;
            border-radius: 8px;
            border: 1px solid var(--stone);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .video-item:hover {
            background: linear-gradient(135deg, rgba(26, 15, 10, 0.6) 0%, rgba(28, 28, 28, 0.6) 100%);
            border-color: var(--bronze);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .video-item.completed {
            background: linear-gradient(135deg, rgba(0, 168, 107, 0.15) 0%, rgba(0, 139, 90, 0.1) 100%);
            border-color: var(--jade);
        }

        .video-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .video-checkbox {
            width: 28px;
            height: 28px;
            cursor: pointer;
            accent-color: var(--jade);
            flex-shrink: 0;
        }

        .video-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .video-title {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--off-white);
            line-height: 1.5;
        }

        .video-title .part-number {
            color: var(--gold);
            margin-right: 0.5rem;
        }

        .video-meta {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .video-duration {
            font-family: 'Crimson Pro', serif;
            color: var(--paper);
            font-weight: 400;
            font-size: 0.9rem;
        }

        .video-part-badge {
            background: transparent;
            padding: 0.35rem 1.25rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-family: 'Cinzel', serif;
            color: var(--gold);
            border: 1px solid var(--stone);
            letter-spacing: 0.1em;
            font-weight: 400;
            flex-shrink: 0;
        }

        .timestamp-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--stone);
        }

        .timestamp-input {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .timestamp-label {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            color: var(--paper);
            letter-spacing: 0.05em;
            text-transform: uppercase;
            min-width: 100px;
        }

        .timestamp-input input {
            flex: 0 0 150px;
            padding: 0.5rem 0.75rem;
            background: rgba(26, 15, 10, 0.6);
            border: 1px solid var(--stone);
            border-radius: 4px;
            color: var(--off-white);
            font-family: 'Crimson Pro', serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .timestamp-input input:focus {
            outline: none;
            border-color: var(--bronze);
            background: rgba(26, 15, 10, 0.8);
        }

        .timestamp-input input::placeholder {
            color: var(--stone);
        }

        .timestamp-input button {
            padding: 0.5rem 1.25rem;
            background: transparent;
            color: var(--paper);
            border: 1px solid var(--stone);
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-weight: 400;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .timestamp-input button:hover {
            background: rgba(205, 127, 50, 0.1);
            border-color: var(--bronze);
            color: var(--bronze);
        }

        .saved-timestamp {
            margin-top: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 168, 107, 0.15);
            border-left: 3px solid var(--jade);
            border-radius: 4px;
            color: var(--jade);
            font-family: 'Crimson Pro', serif;
            font-weight: 400;
            font-size: 0.9rem;
        }

        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            font-weight: 400;
            color: var(--gold);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 1.5rem;
            padding-left: 1rem;
            border-left: 4px solid var(--gold);
        }

        .achievements-grid {
            display: grid;
            gap: 1.5rem;
        }

        .achievement-category {
            background: linear-gradient(135deg, var(--stone) 0%, var(--light-stone) 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid var(--bronze);
            box-shadow: 0 8px 32px var(--shadow);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gold);
        }

        .category-title {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gold);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .category-progress {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.2rem;
            color: var(--paper);
            font-weight: 600;
        }

        .achievement-list {
            display: grid;
            gap: 1rem;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--charcoal);
            border-radius: 8px;
            border: 2px solid var(--stone);
            transition: all 0.3s ease;
        }

        .achievement-item:hover {
            border-color: var(--bronze);
            transform: translateX(5px);
        }

        .achievement-item.completed {
            background: linear-gradient(135deg, rgba(0, 168, 107, 0.2) 0%, rgba(0, 139, 90, 0.2) 100%);
            border-color: var(--jade);
        }

        .achievement-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--gold);
        }

        .achievement-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 1.2rem;
            border: 3px solid;
            flex-shrink: 0;
        }

        .badge-bronze {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
            border-color: #CD7F32;
            color: var(--off-white);
        }

        .badge-silver {
            background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
            border-color: #C0C0C0;
            color: var(--charcoal);
        }

        .badge-gold {
            background: linear-gradient(135deg, var(--gold) 0%, var(--bronze) 100%);
            border-color: var(--gold);
            color: var(--charcoal);
        }

        .badge-platinum {
            background: linear-gradient(135deg, #E5E4E2 0%, #B4B4B4 100%);
            border-color: #E5E4E2;
            color: var(--charcoal);
            box-shadow: 0 0 20px rgba(229, 228, 226, 0.5);
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--off-white);
            margin-bottom: 0.25rem;
        }

        .achievement-description {
            color: var(--paper);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.5;
                transform: translateY(-50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-50%) scale(1.1);
            }
        }

        @keyframes checkmark {
            0% {
                transform: scale(0) rotate(-45deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(0deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.8rem;
                letter-spacing: 0.15em;
            }

            h1 .subtitle-inline {
                font-size: 0.9em;
            }

            .subtitle {
                font-size: 0.7rem;
                letter-spacing: 0.2em;
            }

            header {
                padding: 2rem 1rem;
                min-height: 240px;
            }

            .stats {
                grid-template-columns: 1fr 1fr;
                gap: 0;
            }

            .stat-card {
                padding: 1.5rem 1rem;
                border-right: none;
                border-bottom: 1px solid var(--stone);
            }

            .stat-card:nth-child(2n) {
                border-right: none;
            }

            .stat-card:nth-child(-n+2) {
                border-bottom: 1px solid var(--stone);
            }

            .stat-value {
                font-size: 2rem;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 2rem;
            }

            .tab {
                font-size: 0.9rem;
                padding: 0.75rem 0;
                white-space: nowrap;
            }

            .controls {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .playthrough-selector {
                width: 100%;
                min-width: 0;
            }

            .playthrough-selector select {
                width: 100%;
            }

            .button-group {
                width: 100%;
                flex-wrap: wrap;
            }

            button:not(.tab) {
                flex: 1;
                min-width: 0;
            }

            .video-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .video-checkbox {
                width: 24px;
                height: 24px;
            }

            .video-part-badge {
                align-self: flex-start;
            }

            .timestamp-section {
                margin-top: 0.75rem;
            }

            .timestamp-input {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .timestamp-label {
                min-width: auto;
            }

            .timestamp-input input {
                flex: 1;
            }

            .section-title {
                font-size: 1.1rem;
            }

            .timestamp-input {
                flex-direction: column;
                align-items: stretch;
            }

            .timestamp-input input {
                max-width: none;
            }

            .achievement-badge {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="headerTitle">Black Myth: <span class="subtitle-inline">Wukong</span></h1>
            <div class="subtitle" id="headerSubtitle">æ‚Ÿç©º â€¢ Journey Tracker</div>
            <a href="https://youtube.com/playlist?list=PLtI7vq-NpiU-yKp3_vFavwOVdfmbQM8ey&si=qbAg5KW2gqWXoC5I" target="_blank" class="youtube-link">
                <svg class="youtube-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
                View Playlist
            </a>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="walkthrough">Walkthrough</button>
            <button class="tab" data-tab="achievements">Achievements</button>
        </div>

        <div id="walkthrough" class="tab-content active">
            <div class="controls">
                <div class="playthrough-selector">
                    <label for="playthrough">Current Playthrough</label>
                    <select id="playthrough">
                        <option value="first">First Playthrough</option>
                        <option value="ng+1">New Game+ 1</option>
                        <option value="ng+2">New Game+ 2</option>
                        <option value="ng+3">New Game+ 3</option>
                        <option value="ng+4">New Game+ 4</option>
                        <option value="ng+5">New Game+ 5</option>
                        <option value="ng+6">New Game+ 6</option>
                        <option value="ng+7">New Game+ 7</option>
                        <option value="ng+8">New Game+ 8</option>
                        <option value="ng+9">New Game+ 9</option>
                        <option value="ng+10">New Game+ 10</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="btn-export" onclick="exportProgress()">Export Progress</button>
                    <button class="btn-reset" onclick="resetCurrentPlaythrough()">Reset Current</button>
                    <button class="btn-reset-all" onclick="resetAllProgress()">Reset All</button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Completion</div>
                    <div class="stat-value" id="completion-percentage">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Videos Watched</div>
                    <div class="stat-value" id="videos-watched">0/26</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Time Watched</div>
                    <div class="stat-value" id="time-watched">0h 0m</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Time Progress</div>
                    <div class="stat-value" id="time-percentage">0%</div>
                </div>
            </div>

            <div class="section-title">
                <span>Just Human's 100% Walkthrough</span>
            </div>

            <div class="video-list" id="video-list"></div>
        </div>

        <div id="achievements" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Achievements</div>
                    <div class="stat-value" id="achievement-percentage">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Achievements Unlocked</div>
                    <div class="stat-value" id="achievements-count">0/48</div>
                </div>
                <div class="stat-card"></div>
                <div class="stat-card"></div>
            </div>

            <div class="achievements-grid" id="achievements-grid"></div>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GAME LIBRARY INTEGRATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Detect if running inside Game Library or standalone
        const isInGameLibrary = window.parent && window.parent !== window;
        let gameId = null;
        let trackerProgress = {};
        let gameImageUrl = null;
        
        // First, try to read from URL hash (works for external trackers loaded via iframe.src)
        const hash = window.location.hash.substring(1);
        if (hash) {
            const params = new URLSearchParams(hash);
            const hashGameId = params.get('gameId');
            const progressParam = params.get('progress');
            const imageParam = params.get('image');
            
            if (hashGameId) {
                gameId = hashGameId;
                console.log('ðŸ“ Game ID from URL hash:', gameId);
            }
            
            if (imageParam) {
                gameImageUrl = decodeURIComponent(imageParam);
                console.log('ðŸ–¼ï¸ Game image URL:', gameImageUrl);
            }
            
            if (progressParam) {
                try {
                    trackerProgress = JSON.parse(decodeURIComponent(progressParam));
                    console.log('ðŸ“¦ Progress from URL hash:', trackerProgress);
                } catch (e) {
                    console.warn('âš ï¸ Failed to parse progress from URL hash:', e);
                }
            }
        }
        
        // Fallback: check for injected window properties (for inline trackers)
        if (!gameId && isInGameLibrary) {
            gameId = window.gameLibraryGameId || null;
            trackerProgress = window.trackerProgress || {};
            gameImageUrl = window.gameImageUrl || null;
            console.log('ðŸŽ® Using injected Game Library data');
        }
        
        console.log('ðŸŽ® Running in ' + (isInGameLibrary ? 'Game Library' : 'Standalone') + ' mode');
        console.log('ðŸ“Š Game ID:', gameId);
        console.log('ðŸ“Š Loaded progress:', trackerProgress);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VIDEO AND ACHIEVEMENT DATA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const videos = [
            { part: 1, title: "Chapter 1 Forest of Wolves Walkthrough & Guide", duration: "43:13", views: "211K", thumbnail: "01" },
            { part: 2, title: "Chapter 1 Bamboo Grove Walkthrough & Guide", duration: "34:48", views: "80K", thumbnail: "02" },
            { part: 3, title: "Chapter 1 Black Wind Cave Walkthrough & Guide", duration: "24:14", views: "56K", thumbnail: "03" },
            { part: 4, title: "Chapter 2 Sandgate Village Walkthrough & Guide", duration: "42:04", views: "161K", thumbnail: "04" },
            { part: 5, title: "Chapter 2 Fright Cliff Walkthrough & Guide", duration: "48:57", views: "104K", thumbnail: "05" },
            { part: 6, title: "Chapter 2 Yellow Wind Formation Walkthrough & Guide", duration: "36:08", views: "84K", thumbnail: "06" },
            { part: 7, title: "Chapter 2 Secret Kingdom of Sahali & Loong Dragons Walkthrough", duration: "37:18", views: "86K", thumbnail: "07" },
            { part: 8, title: "Chapter 2 Old Rattle Drum & Cellar Walkthrough & Guide", duration: "33:30", views: "77K", thumbnail: "08" },
            { part: 9, title: "Chapter 3 Snowhill Path Walkthrough & Guide", duration: "31:42", views: "101K", thumbnail: "09" },
            { part: 10, title: "Chapter 3 Pagoda Realm Walkthrough & Guide", duration: "1:03:16", views: "153K", thumbnail: "10" },
            { part: 11, title: "Chapter 3 The Great Pagoda Walkthrough & Guide", duration: "37:27", views: "99K", thumbnail: "11" },
            { part: 12, title: "Chapter 3 Bitter Lake & Ruyi Scroll Walkthrough & Guide", duration: "53:29", views: "124K", thumbnail: "12" },
            { part: 13, title: "Chapter 3 Mindfulness Cliff Walkthrough & Guide", duration: "23:25", views: "75K", thumbnail: "13" },
            { part: 14, title: "Chapter 3 Valley of Ecstasy Walkthrough & Guide", duration: "55:05", views: "113K", thumbnail: "14" },
            { part: 15, title: "Chapter 3 New Thunderclap Temple Walkthrough & Guide", duration: "54:59", views: "111K", thumbnail: "15" },
            { part: 16, title: "Chapter 4 Webbed Hollow Walkthrough & Guide", duration: "50:43", views: "110K", thumbnail: "16" },
            { part: 17, title: "Chapter 4 The Verdure Bridge & Middle Hollow Walkthrough & Guide", duration: "42:51", views: "76K", thumbnail: "17" },
            { part: 18, title: "Chapter 4 Lower Hollow & Yellow Loong Walkthrough & Guide", duration: "48:03", views: "102K", thumbnail: "18" },
            { part: 19, title: "Chapter 4 Temple of Yellow Flowers Walkthrough & Guide", duration: "29:40", views: "73K", thumbnail: "19" },
            { part: 20, title: "Chapter 4 Secret Area: Purple Cloud Mountain Walkthrough & Guide", duration: "51:09", views: "82K", thumbnail: "20" },
            { part: 21, title: "Chapter 5 Woods of Ember Walkthrough & Guide", duration: "36:58", views: "65K", thumbnail: "21" },
            { part: 22, title: "Chapter 5 Furnace Valley Walkthrough & Guide", duration: "47:53", views: "77K", thumbnail: "22" },
            { part: 23, title: "Chapter 5 Field of Fire Walkthrough & Guide", duration: "24:31", views: "56K", thumbnail: "23" },
            { part: 24, title: "Chapter 5 Secret Bishui Cave Walkthrough & Guide", duration: "32:25", views: "75K", thumbnail: "24" },
            { part: 25, title: "All Enemies & Plants Drops (Curios / Soaks & Armor) & Best Rotation Farm", duration: "53:23", views: "41K", isDLC: true, thumbnail: "25" },
            { part: 26, title: "Chapter 6 & Platinum Trophy Walkthrough & Guide (Final)", duration: "2:07:14", views: "164K", thumbnail: "26" }
        ];

        const playlistInfo = {
            creator: "Just Human",
            totalVideos: 26,
            totalViews: "961,131"
        };

        const achievements = {
            story: [
                { name: "A Duel of Destiny", description: "Defeat Erlang, the Sacred Divinity", grade: "gold" },
                { name: "A Great Gale Conquers Even the Fiercest Tiger", description: "Defeat the Tiger Vanguard", grade: "bronze" },
                { name: "A Heart of Ice and Ashes", description: "Defeat Mother of Stones", grade: "silver" },
                { name: "A Lesson in Cause and Effect", description: "Defeat the Scorpion Prince", grade: "silver" },
                { name: "A Spark of Dragon Fire", description: "Defeat the Red Boy", grade: "bronze" },
                { name: "A Strand of Silky Threads", description: "Defeat the Hundred-Eyed Daoist Master", grade: "silver" },
                { name: "Where the Mind Resides", description: "Defeat Yellowbrow", grade: "gold" },
                { name: "Within Arms' Reach", description: "Defeat Lingxuzi", grade: "bronze" }
            ],
            combat: [
                { name: "Blazing Black Wind", description: "Learn all offensive Fire spells", grade: "bronze" },
                { name: "Earthen Might", description: "Defeat Earth Wolf (Secret Boss)", grade: "silver" },
                { name: "Full Moon in the Vale", description: "Defeat all Yaoguai Chiefs in Chapters 1-6", grade: "gold" },
                { name: "Thunderous Renown", description: "Learn all offensive Thunder spells", grade: "bronze" },
                { name: "Unbroken Golden Guard", description: "Defeat Shigandang", grade: "silver" },
                { name: "Where Frost Meets Flame", description: "Defeat Yin Tiger", grade: "silver" }
            ],
            collectibles: [
                { name: "A Curious Collection", description: "Collect 50 different types of Curios", grade: "bronze" },
                { name: "An Eventful Journey", description: "Learn all secrets in the first 4 chapters", grade: "silver" },
                { name: "Brewer's Bounty", description: "Craft 10 drinks", grade: "bronze" },
                { name: "Fruits of Labor", description: "Collect 10 different types of Spirit", grade: "bronze" },
                { name: "Go With the Flow", description: "Learn all Vessel spells", grade: "bronze" },
                { name: "Seeds Sown, Fruits Reaped", description: "Collect all Spirits", grade: "gold" },
                { name: "Shifting Seasons of the Mind", description: "Collect all Luojia Fragrant Vines", grade: "bronze" },
                { name: "Swift as Wind", description: "Learn all transformations", grade: "silver" }
            ],
            progression: [
                { name: "A Life Lesson Learned", description: "Die for the first time", grade: "bronze" },
                { name: "A Monkey's Testament", description: "Reach Mount Huaguo", grade: "bronze" },
                { name: "Blazing Through the Snow", description: "Reach Chapter 3", grade: "bronze" },
                { name: "Entering the Den", description: "Reach Chapter 4", grade: "bronze" },
                { name: "Fiery Venture", description: "Reach Chapter 5", grade: "bronze" },
                { name: "Gale of the Kingdom", description: "Reach Chapter 2", grade: "bronze" },
                { name: "Nowhere to Escape", description: "Enter the Pagoda Realm", grade: "bronze" },
                { name: "The End", description: "Complete Chapter 6", grade: "gold" },
                { name: "To the South", description: "Reach Bishui Cave", grade: "bronze" },
                { name: "When Thousand Autumns Elapse", description: "Defeat all six main bosses with New Game+", grade: "gold" }
            ],
            exploration: [
                { name: "A Pound of Cure", description: "Heal using a Gourd 100 times", grade: "bronze" },
                { name: "Bodhi's Resonance", description: "Reach the True Ending", grade: "platinum" },
                { name: "Brews and Vessels", description: "Upgrade the Gourd 3 times", grade: "bronze" },
                { name: "Builder's Pastime", description: "Craft 10 different equipment", grade: "bronze" },
                { name: "Deeper Dive", description: "Enhance any equipment to +6", grade: "bronze" },
                { name: "High Spirits", description: "Drink from Gourd 100 times", grade: "bronze" },
                { name: "Key to the Chambers", description: "Find all Luojia Fragrant Vines in Chapter 3", grade: "bronze" },
                { name: "Monkey King's Welcome", description: "Defeat 1000 Yaoguais", grade: "silver" },
                { name: "Rock Solid", description: "Acquire 36 Stone Spirits", grade: "silver" },
                { name: "Seasons of the Vale", description: "Discover the Four Seasons", grade: "bronze" },
                { name: "The Bane of the Yellow Wind", description: "Defeat all Yaoguai Chiefs in Chapter 2", grade: "bronze" },
                { name: "The Gateway to a New Journey", description: "Open the first gate in Chapter 1", grade: "bronze" },
                { name: "Those Who Chant Sutras", description: "Find all monks at New Thunderclap Temple", grade: "bronze" },
                { name: "Where Tigers Dwell", description: "Defeat all Yaoguai Chiefs in Chapter 1", grade: "bronze" }
            ],
            dlc: [
                { name: "Flicker of Stone Spirits", description: "Collect all Stone Spirits (DLC)", grade: "gold" },
                { name: "Master Craftsman", description: "Upgrade all weapons to maximum level (DLC)", grade: "gold" }
            ]
        };

        let currentPlaythrough = 'first';
        let progressData = loadProgress();

        function loadProgress() {
            // Load from Game Library if available
            // The trackerProgress object contains the data directly
            if (trackerProgress && Object.keys(trackerProgress).length > 0) {
                console.log('ðŸ“¥ Loading progress from Game Library:', trackerProgress);
                
                // Ensure each playthrough has proper structure
                const ensureStructure = (pt) => {
                    if (!pt || typeof pt !== 'object') {
                        return { videos: {}, timestamps: {} };
                    }
                    return {
                        videos: pt.videos || {},
                        timestamps: pt.timestamps || {}
                    };
                };
                
                const loadedData = {
                    first: ensureStructure(trackerProgress.first),
                    'ng+1': ensureStructure(trackerProgress['ng+1']),
                    'ng+2': ensureStructure(trackerProgress['ng+2']),
                    'ng+3': ensureStructure(trackerProgress['ng+3']),
                    'ng+4': ensureStructure(trackerProgress['ng+4']),
                    'ng+5': ensureStructure(trackerProgress['ng+5']),
                    'ng+6': ensureStructure(trackerProgress['ng+6']),
                    'ng+7': ensureStructure(trackerProgress['ng+7']),
                    'ng+8': ensureStructure(trackerProgress['ng+8']),
                    'ng+9': ensureStructure(trackerProgress['ng+9']),
                    'ng+10': ensureStructure(trackerProgress['ng+10']),
                    achievements: trackerProgress.achievements || {}
                };
                
                if (trackerProgress.currentPlaythrough) {
                    currentPlaythrough = trackerProgress.currentPlaythrough;
                }
                
                console.log('âœ… Progress loaded successfully');
                console.log('   - Current playthrough:', currentPlaythrough);
                console.log('   - Videos completed:', Object.keys(loadedData[currentPlaythrough]?.videos || {}).length);
                console.log('   - Achievements:', Object.keys(loadedData.achievements).length);
                
                return loadedData;
            }
            
            // Otherwise try localStorage
            const saved = localStorage.getItem('bmw-tracker-data');
            if (saved) {
                console.log('ðŸ“¦ Loading from localStorage');
                return JSON.parse(saved);
            }
            
            console.log('â„¹ï¸ No saved progress (new tracker)');
            return {
                first: { videos: {}, timestamps: {} },
                'ng+1': { videos: {}, timestamps: {} },
                'ng+2': { videos: {}, timestamps: {} },
                'ng+3': { videos: {}, timestamps: {} },
                'ng+4': { videos: {}, timestamps: {} },
                'ng+5': { videos: {}, timestamps: {} },
                'ng+6': { videos: {}, timestamps: {} },
                'ng+7': { videos: {}, timestamps: {} },
                'ng+8': { videos: {}, timestamps: {} },
                'ng+9': { videos: {}, timestamps: {} },
                'ng+10': { videos: {}, timestamps: {} },
                achievements: {}
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CALCULATE TIME WATCHED
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function calculateTimeWatched(playthrough = null) {
            // If playthrough is specified, calculate for that playthrough only
            // If null, calculate for current playthrough
            const targetPlaythrough = playthrough || currentPlaythrough;
            const currentData = progressData[targetPlaythrough];
            let completedMinutes = 0;
            
            videos.forEach((video, index) => {
                if (currentData.videos[index]) {
                    completedMinutes += parseDuration(video.duration);
                }
            });
            
            const hours = Math.floor(completedMinutes / 60);
            const minutes = Math.floor(completedMinutes % 60);
            
            return { hours, minutes, totalMinutes: completedMinutes };
        }
        
        function calculateTotalTimeAllPlaythroughs() {
            // Calculate cumulative time across all playthroughs
            let totalMinutes = 0;
            
            const playthroughs = ['first', 'ng+1', 'ng+2', 'ng+3', 'ng+4', 'ng+5', 'ng+6', 'ng+7', 'ng+8', 'ng+9', 'ng+10'];
            
            playthroughs.forEach(pt => {
                if (progressData[pt]) {
                    videos.forEach((video, index) => {
                        if (progressData[pt].videos && progressData[pt].videos[index]) {
                            totalMinutes += parseDuration(video.duration);
                        }
                    });
                }
            });
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            
            return { hours, minutes, totalMinutes };
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SAVE PROGRESS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function saveProgress() {
            // Save to localStorage
            localStorage.setItem('bmw-tracker-data', JSON.stringify(progressData));
            
            // Save to Game Library if available
            saveProgressToGameLibrary();
        }
        
        function saveProgressToGameLibrary() {
            if (!isInGameLibrary || !gameId) {
                return;
            }
            
            const progressToSave = {
                currentPlaythrough: currentPlaythrough,
                first: progressData.first,
                'ng+1': progressData['ng+1'],
                'ng+2': progressData['ng+2'],
                'ng+3': progressData['ng+3'],
                'ng+4': progressData['ng+4'],
                'ng+5': progressData['ng+5'],
                'ng+6': progressData['ng+6'],
                'ng+7': progressData['ng+7'],
                'ng+8': progressData['ng+8'],
                'ng+9': progressData['ng+9'],
                'ng+10': progressData['ng+10'],
                achievements: progressData.achievements,
                lastUpdated: new Date().toISOString()
            };
            
            // Calculate stats for display
            const currentData = progressData[currentPlaythrough];
            const completedVideos = Object.keys(currentData.videos).filter(k => currentData.videos[k]).length;
            const totalVideos = videos.length;
            const completionPercent = Math.round((completedVideos / totalVideos) * 100);
            
            // Calculate current playthrough time (for console log)
            const currentTimeData = calculateTimeWatched();
            
            // Calculate TOTAL time across all playthroughs (for Game Library card)
            const totalTimeData = calculateTotalTimeAllPlaythroughs();
            
            // Send to Game Library
            window.parent.postMessage({
                type: 'TRACKER_PROGRESS_UPDATE',
                gameId: gameId,
                checkboxId: 'bmw_complete_data',
                checked: true,
                allProgress: progressToSave
            }, '*');
            
            // Also send overall game stats with TOTAL cumulative hours
            window.parent.postMessage({
                type: 'TRACKER_SYNC',
                gameId: gameId,
                hours: totalTimeData.hours + (totalTimeData.minutes >= 30 ? 1 : 0), // Total time across all playthroughs
                progress: completionPercent
            }, '*');
            
            console.log('âœ… Synced to Game Library:', {
                playthrough: currentPlaythrough,
                completion: completionPercent + '%',
                videos: completedVideos + '/' + totalVideos,
                achievements: Object.keys(progressData.achievements).length,
                currentPlaythroughTime: currentTimeData.hours + 'H ' + currentTimeData.minutes + 'M',
                totalTimeAllPlaythroughs: totalTimeData.hours + 'H ' + totalTimeData.minutes + 'M'
            });
            
            showSyncNotification();
        }
        
        function showSyncNotification() {
            // Check if notification already exists
            if (document.querySelector('.sync-notification')) return;
            
            const notification = document.createElement('div');
            notification.className = 'sync-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                z-index: 99999;
                font-weight: 600;
                font-family: system-ui, -apple-system, sans-serif;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = 'âœ“ Synced to Library';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function parseDuration(duration) {
            const parts = duration.split(':');
            let minutes = 0;
            if (parts.length === 3) {
                minutes = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            } else {
                minutes = parseInt(parts[0]);
            }
            return minutes;
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        function updateStats() {
            const currentData = progressData[currentPlaythrough];
            const completedVideos = Object.values(currentData.videos).filter(v => v).length;
            const totalVideos = videos.length;
            const completionPercentage = Math.round((completedVideos / totalVideos) * 100);

            let totalMinutes = 0;
            let watchedMinutes = 0;

            videos.forEach((video, index) => {
                const duration = parseDuration(video.duration);
                totalMinutes += duration;
                if (currentData.videos[index]) {
                    watchedMinutes += duration;
                }
            });

            const timePercentage = Math.round((watchedMinutes / totalMinutes) * 100);

            document.getElementById('completion-percentage').textContent = `${completionPercentage}%`;
            document.getElementById('videos-watched').textContent = `${completedVideos}/${totalVideos}`;
            document.getElementById('time-watched').textContent = formatTime(watchedMinutes);
            document.getElementById('time-percentage').textContent = `${timePercentage}%`;

            // Update achievements
            const achievementsData = progressData.achievements;
            let totalAchievements = 0;
            let completedAchievements = 0;

            Object.values(achievements).forEach(category => {
                category.forEach(achievement => {
                    totalAchievements++;
                    if (achievementsData[achievement.name]) {
                        completedAchievements++;
                    }
                });
            });

            const achievementPercentage = Math.round((completedAchievements / totalAchievements) * 100);
            document.getElementById('achievement-percentage').textContent = `${achievementPercentage}%`;
            document.getElementById('achievements-count').textContent = `${completedAchievements}/${totalAchievements}`;
        }

        function renderVideos() {
            const videoList = document.getElementById('video-list');
            const currentData = progressData[currentPlaythrough];
            
            videoList.innerHTML = videos.map((video, index) => {
                const isCompleted = currentData.videos[index] || false;
                const savedTimestamp = currentData.timestamps[index] || '';
                
                return `
                    <div class="video-item ${isCompleted ? 'completed' : ''}" data-index="${index}">
                        <div class="video-header">
                            <input type="checkbox" class="video-checkbox" ${isCompleted ? 'checked' : ''} 
                                   onchange="toggleVideo(${index})">
                            <div class="video-info">
                                <div class="video-title">
                                    <span class="part-number">Part ${video.part}</span> - ${video.title}
                                </div>
                                <div class="video-meta">
                                    <span class="video-duration">Duration: ${video.duration}</span>
                                </div>
                            </div>
                            <span class="video-part-badge">Part ${video.part}</span>
                        </div>
                        ${!isCompleted ? `
                        <div class="timestamp-section">
                            <div class="timestamp-input">
                                <span class="timestamp-label">Paused At:</span>
                                <input type="text" placeholder="00:00:00" 
                                       value="${savedTimestamp}" 
                                       onchange="saveTimestamp(${index}, this.value)">
                                <button onclick="saveTimestamp(${index}, this.previousElementSibling.value)">Save</button>
                            </div>
                            ${savedTimestamp ? `<div class="saved-timestamp">â± Saved: ${savedTimestamp}</div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderAchievements() {
            const achievementsGrid = document.getElementById('achievements-grid');
            const achievementsData = progressData.achievements;
            
            achievementsGrid.innerHTML = Object.entries(achievements).map(([category, items]) => {
                const completed = items.filter(item => achievementsData[item.name]).length;
                const total = items.length;
                const percentage = Math.round((completed / total) * 100);
                
                const categoryTitles = {
                    story: 'Story Achievements',
                    combat: 'Combat Mastery',
                    collectibles: 'Collector',
                    progression: 'Journey Progress',
                    exploration: 'Explorer',
                    dlc: 'DLC Content'
                };
                
                return `
                    <div class="achievement-category">
                        <div class="category-header">
                            <h3 class="category-title">${categoryTitles[category]}</h3>
                            <div class="category-progress">${completed}/${total} (${percentage}%)</div>
                        </div>
                        <div class="achievement-list">
                            ${items.map(item => {
                                const isCompleted = achievementsData[item.name] || false;
                                return `
                                    <div class="achievement-item ${isCompleted ? 'completed' : ''}">
                                        <input type="checkbox" class="achievement-checkbox" ${isCompleted ? 'checked' : ''} 
                                               onchange="toggleAchievement('${item.name}')">
                                        <div class="achievement-badge badge-${item.grade}">
                                            ${item.grade === 'platinum' ? 'â—†' : item.grade === 'gold' ? 'â—ˆ' : item.grade === 'silver' ? 'â—‡' : 'â—†'}
                                        </div>
                                        <div class="achievement-info">
                                            <div class="achievement-name">${item.name}</div>
                                            <div class="achievement-description">${item.description}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleVideo(index) {
            const currentData = progressData[currentPlaythrough];
            currentData.videos[index] = !currentData.videos[index];
            
            if (currentData.videos[index]) {
                delete currentData.timestamps[index];
            }
            
            saveProgress();
            renderVideos();
            updateStats();
        }

        function saveTimestamp(index, timestamp) {
            if (timestamp.trim()) {
                progressData[currentPlaythrough].timestamps[index] = timestamp.trim();
            } else {
                delete progressData[currentPlaythrough].timestamps[index];
            }
            saveProgress();
            renderVideos();
        }

        function toggleAchievement(name) {
            progressData.achievements[name] = !progressData.achievements[name];
            if (!progressData.achievements[name]) {
                delete progressData.achievements[name];
            }
            saveProgress();
            renderAchievements();
            updateStats();
        }

        function exportProgress() {
            const dataStr = JSON.stringify(progressData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bmw-tracker-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function resetCurrentPlaythrough() {
            if (confirm(`Are you sure you want to reset ${currentPlaythrough === 'first' ? 'First Playthrough' : currentPlaythrough.toUpperCase()}? This cannot be undone.`)) {
                progressData[currentPlaythrough] = { videos: {}, timestamps: {} };
                saveProgress();
                renderVideos();
                updateStats();
            }
        }

        function resetAllProgress() {
            if (confirm('Are you sure you want to reset ALL progress including achievements? This cannot be undone.')) {
                if (confirm('This will delete everything. Are you absolutely sure?')) {
                    progressData = {
                        first: { videos: {}, timestamps: {} },
                        'ng+1': { videos: {}, timestamps: {} },
                        'ng+2': { videos: {}, timestamps: {} },
                        'ng+3': { videos: {}, timestamps: {} },
                        'ng+4': { videos: {}, timestamps: {} },
                        'ng+5': { videos: {}, timestamps: {} },
                        'ng+6': { videos: {}, timestamps: {} },
                        'ng+7': { videos: {}, timestamps: {} },
                        'ng+8': { videos: {}, timestamps: {} },
                        'ng+9': { videos: {}, timestamps: {} },
                        'ng+10': { videos: {}, timestamps: {} },
                        achievements: {}
                    };
                    saveProgress();
                    renderVideos();
                    renderAchievements();
                    updateStats();
                }
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Playthrough selector
        document.getElementById('playthrough').addEventListener('change', (e) => {
            currentPlaythrough = e.target.value;
            renderVideos();
            updateStats();
        });

        // Listen for manual sync requests from Game Library
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'REQUEST_PROGRESS_SYNC') {
                console.log('ðŸ“¥ Received manual sync request from Game Library');
                
                // Trigger sync to library (this function handles everything)
                saveProgressToGameLibrary();
            }
        });

        // Apply header background image if available
        function applyHeaderBackground() {
            const header = document.querySelector('header');
            const title = document.getElementById('headerTitle');
            const subtitle = document.getElementById('headerSubtitle');
            
            if (gameImageUrl && header) {
                // Apply background image
                header.style.background = `
                    linear-gradient(135deg, rgba(10, 10, 10, 0.7) 0%, rgba(28, 28, 28, 0.85) 100%),
                    url('${gameImageUrl}') center/cover no-repeat
                `;
                header.style.backgroundBlendMode = 'overlay';
                
                // Hide title and subtitle when image is present
                if (title) title.style.display = 'none';
                if (subtitle) subtitle.style.display = 'none';
                
                console.log('ðŸ–¼ï¸ Applied header background image and hid text');
            } else {
                // No image - show title and subtitle
                if (title) title.style.display = '';
                if (subtitle) subtitle.style.display = '';
                console.log('ðŸ“ No image URL - showing header text');
            }
        }

        // Initialize
        renderVideos();
        renderAchievements();
        updateStats();
        applyHeaderBackground();
    </script>
</body>
</html>